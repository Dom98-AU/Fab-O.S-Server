#!/bin/bash

# Fab.OS Platform - Pre-Commit Hook
# Validates URL architecture before allowing commits
# Installation: Copy to .git/hooks/pre-commit and make executable

echo "üîç Fab.OS URL Architecture Validation"
echo "======================================"
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to check if dotnet is installed
check_dotnet() {
    # Check for both 'dotnet' (Linux/Mac) and 'dotnet.exe' (WSL/Windows)
    if command -v dotnet &> /dev/null; then
        DOTNET_CMD="dotnet"
    elif command -v dotnet.exe &> /dev/null; then
        DOTNET_CMD="dotnet.exe"
    else
        echo -e "${RED}‚ùå ERROR: .NET SDK not found${NC}"
        echo "   Please install .NET 8 SDK to run route validation"
        exit 1
    fi
}

# Function to run route validation tests
run_route_tests() {
    echo "üìù Running route validation tests..."
    echo ""

    # Run tests
    $DOTNET_CMD test --filter "Category=RouteValidation" --no-build --verbosity quiet

    local exit_code=$?

    if [ $exit_code -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úÖ All route validation tests passed${NC}"
        return 0
    else
        echo ""
        echo -e "${RED}‚ùå Route validation tests failed${NC}"
        echo ""
        echo "Common issues:"
        echo "  ‚Ä¢ Routes missing /{tenantSlug} parameter"
        echo "  ‚Ä¢ Uppercase letters in URLs (must be lowercase)"
        echo "  ‚Ä¢ Singular resource names (must be plural)"
        echo "  ‚Ä¢ Missing route constraints on IDs (use {id:int})"
        echo "  ‚Ä¢ Underscores in URLs (use hyphens)"
        echo ""
        echo "Fix these issues before committing."
        echo "See: Fab O.S System Architecture/URL-ROUTING-STANDARDS.md"
        return 1
    fi
}

# Function to validate changed .razor files
validate_changed_files() {
    echo "üìÇ Checking changed Razor files..."
    echo ""

    # Get list of staged .razor files
    local razor_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.razor$')

    if [ -z "$razor_files" ]; then
        echo "   No Razor files changed"
        return 0
    fi

    local has_violations=0

    for file in $razor_files; do
        if [ -f "$file" ]; then
            # Extract @page directives
            local page_directives=$(grep -E "^@page" "$file")

            if [ ! -z "$page_directives" ]; then
                echo "   Checking: $file"

                # Check each @page directive
                while IFS= read -r line; do
                    # Extract the route from @page directive
                    local route=$(echo "$line" | sed -n 's/@page "\([^"]*\)".*/\1/p')

                    if [ ! -z "$route" ]; then
                        # Check if route starts with /{tenantSlug}
                        if [[ ! "$route" =~ ^\{tenantSlug\}/ ]]; then
                            echo -e "      ${RED}‚ùå Missing {tenantSlug}: $route${NC}"
                            has_violations=1
                        fi

                        # Check for uppercase (excluding parameters)
                        local route_without_params=$(echo "$route" | sed 's/{[^}]*}//g')
                        if [[ "$route_without_params" =~ [A-Z] ]]; then
                            echo -e "      ${YELLOW}‚ö†Ô∏è  Contains uppercase: $route${NC}"
                            has_violations=1
                        fi

                        # Check for underscores (excluding parameters)
                        if [[ "$route_without_params" =~ _ ]]; then
                            echo -e "      ${YELLOW}‚ö†Ô∏è  Contains underscore: $route${NC}"
                            has_violations=1
                        fi

                        # Check for ID parameters without constraints
                        if [[ "$route" =~ \{[^}]*id[^}]*\} ]] && [[ ! "$route" =~ :int ]]; then
                            echo -e "      ${RED}‚ùå Missing :int constraint: $route${NC}"
                            has_violations=1
                        fi

                        if [ $has_violations -eq 0 ]; then
                            echo -e "      ${GREEN}‚úì Valid: $route${NC}"
                        fi
                    fi
                done <<< "$page_directives"
            fi
        fi
    done

    echo ""

    if [ $has_violations -eq 1 ]; then
        echo -e "${RED}‚ùå URL architecture violations found in staged files${NC}"
        return 1
    else
        echo -e "${GREEN}‚úÖ All staged Razor files comply with URL architecture${NC}"
        return 0
    fi
}

# Main execution
main() {
    check_dotnet

    local file_check_result=0
    local test_result=0

    # Validate changed files
    validate_changed_files
    file_check_result=$?

    # Run tests if project has been built
    if [ -d "bin" ]; then
        run_route_tests
        test_result=$?
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Skipping route tests (project not built)${NC}"
        echo "   Run 'dotnet build' to enable pre-commit tests"
    fi

    echo ""

    # Determine overall result
    if [ $file_check_result -eq 0 ] && [ $test_result -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Pre-commit validation passed${NC}"
        echo "   Commit allowed"
        exit 0
    else
        echo -e "${RED}‚ùå Pre-commit validation failed${NC}"
        echo "   Commit blocked"
        echo ""
        echo "To bypass this check (NOT RECOMMENDED):"
        echo "  git commit --no-verify"
        echo ""
        echo "To fix violations:"
        echo "  1. Review URL-ROUTING-STANDARDS.md"
        echo "  2. Update routes to include /{tenantSlug}"
        echo "  3. Use lowercase, plural, kebab-case URLs"
        echo "  4. Add :int constraints to ID parameters"
        exit 1
    fi
}

# Run main function
main

@rendermode InteractiveServer
@using FabOS.WebServer.Services
@inject SidebarService SidebarService
@inject NavigationService NavService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="fabos-sidebar @(SidebarService.IsCollapsed ? "collapsed" : "") @(SidebarService.IsExpanded ? "expanded" : "") @(SidebarService.IsPinMode ? "pin-mode" : "")">

    <!-- Header Section -->
    <FabOSSidebarHeader />

    <!-- Controls Section (Expand/Pin Mode) -->
    @if (!SidebarService.IsCollapsed)
    {
        <FabOSSidebarControls />
    }

    <!-- Module Selector Dropdown -->
    <FabOSModuleSelector />

    <!-- Sidebar Content -->
    <FabOSSidebarContent>
        @if (SidebarService.IsExpanded)
        {
            <FabOSSidebarExpandedView />
        }
        else if (!SidebarService.IsCollapsed)
        {
            <!-- Pinned Section -->
            @if (SidebarService.GetPinnedUrls().Any())
            {
                <FabOSSidebarPinnedSection />
            }

            <!-- Standard Navigation -->
            <FabOSSidebarStandardView />
        }
        else
        {
            <!-- Collapsed View - Icons Only -->
            @if (_collapsedNavItems == null)
            {
                <nav class="fabos-standard-nav">
                    <div class="fabos-nav-loading">...</div>
                </nav>
            }
            else
            {
                <nav class="fabos-standard-nav">
                    @foreach (var item in _collapsedNavItems)
                    {
                        <a href="@item.Url" class="fabos-nav-item" title="@item.Title">
                            <span class="fabos-nav-icon">
                                <LucideIcon Name="@item.Icon" Size="20" />
                            </span>
                        </a>
                    }
                </nav>
            }
        }
    </FabOSSidebarContent>

    <!-- Footer Section -->
    <FabOSSidebarFooter />
</div>

@code {
    private IEnumerable<FabOS.WebServer.Models.NavigationItem>? _collapsedNavItems;

    protected override async Task OnInitializedAsync()
    {
        await LoadCollapsedNavItems();
    }

    private async Task LoadCollapsedNavItems()
    {
        _collapsedNavItems = await NavService.GetModuleItemsAsync(SidebarService.CurrentModule);
        StateHasChanged();
    }

    private void OnStateChanged()
    {
        _ = LoadCollapsedNavItems();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SidebarService.InitializeAsync();
            SidebarService.OnStateChanged += OnStateChanged;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        SidebarService.OnStateChanged -= OnStateChanged;
    }
}

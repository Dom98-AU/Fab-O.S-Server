@page "/{tenantSlug}/trace/customers/{id:int}"
@rendermode InteractiveServer
@using FabOS.WebServer.Components.Shared
@using FabOS.WebServer.Components.Shared.Interfaces
@using FabOS.WebServer.Data.Contexts
@using FabOS.WebServer.Models.Entities
@using Microsoft.EntityFrameworkCore

<PageTitle>@(Id == 0 ? "New Customer" : customer?.Name ?? "Customer Details") - Fab.OS</PageTitle>

<!-- Standard Toolbar -->
<StandardToolbar ActionProvider="@this" ShowSearch="false" PageType="PageType.Card" />

<!-- Main Content Container -->
<div class="takeoff-layout">
    @if (isLoading)
    {
        <!-- Loading State -->
        <div class="takeoff-loading">
            <div class="takeoff-spinner"></div>
            <p>Loading customer details...</p>
        </div>
    }
    else if (customer == null && !isNewCustomer)
    {
        <!-- Error State -->
        <div class="takeoff-error">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Customer Not Found</h3>
            <p>The requested customer could not be found.</p>
            <button class="btn btn-primary" @onclick="NavigateBack">
                <i class="fas fa-arrow-left"></i>
                Back to Customers
            </button>
        </div>
    }
    else
    {
        <!-- Container Wrapper -->
        <div class="takeoff-container">
            <!-- Collapsible Sections -->
            <div class="takeoff-sections">

                <!-- General Section (Customer Information) -->
                <div class="takeoff-section">
                    <div class="takeoff-section-header @(IsSectionExpanded("general") ? "expanded" : "")" @onclick="@(() => ToggleSection("general"))">
                        <div class="section-header-content">
                            <i class="fas fa-info-circle section-icon"></i>
                            <span class="section-title">Customer Information</span>
                            @if (!isNewCustomer && customer != null)
                            {
                                <span class="takeoff-badge @(customer.IsActive ? "status-complete" : "status-cancelled")">
                                    @(customer.IsActive ? "Active" : "Inactive")
                                </span>
                            }
                        </div>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <div class="takeoff-section-content @(IsSectionExpanded("general") ? "expanded" : "collapsed")">
                        <!-- Basic Information -->
                        <div class="takeoff-form-grid two-column">
                            <!-- Customer No (Auto-generated) - First Field -->
                            <div class="takeoff-form-group">
                                <label class="takeoff-form-label">Customer No</label>
                                @if (isEditMode && isNewCustomer)
                                {
                                    <input type="text" class="takeoff-form-control" value="@customer.Code"
                                           placeholder="Will be auto-generated on save" readonly />
                                }
                                else
                                {
                                    <p class="takeoff-form-control-plaintext">@(customer.Code ?? "Not set")</p>
                                }
                            </div>

                            <!-- Customer Name -->
                            <div class="takeoff-form-group">
                                <label class="takeoff-form-label">Customer Name <span class="text-danger">*</span></label>
                                @if (isEditMode)
                                {
                                    <input type="text" class="takeoff-form-control" @bind="customer.Name" @bind:event="oninput" @onchange="OnFieldChanged" placeholder="Enter customer name" required />
                                }
                                else
                                {
                                    <p class="takeoff-form-control-plaintext">@customer.Name</p>
                                }
                            </div>
                            <div class="takeoff-form-group">
                                <label class="takeoff-form-label">ABN</label>
                                @if (isEditMode)
                                {
                                    <div class="input-with-button">
                                        <input type="text" class="takeoff-form-control" @bind="customer.ABN" @bind:event="oninput" @onchange="OnFieldChanged" placeholder="Enter ABN" />
                                        <button type="button" class="btn-lookup" @onclick="ShowAbnLookupModal" title="Lookup ABN">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <p class="takeoff-form-control-plaintext">@(customer.ABN ?? "Not provided")</p>
                                }
                            </div>
                            <div class="takeoff-form-group">
                                <label class="takeoff-form-label">Industry</label>
                                @if (isEditMode)
                                {
                                    <input type="text" class="takeoff-form-control" @bind="customer.Industry" @bind:event="oninput" @onchange="OnFieldChanged" placeholder="Enter industry" />
                                }
                                else
                                {
                                    <p class="takeoff-form-control-plaintext">@(customer.Industry ?? "Not specified")</p>
                                }
                            </div>
                            <div class="takeoff-form-group full-width">
                                <label class="takeoff-form-label">Website</label>
                                @if (isEditMode)
                                {
                                    <input type="url" class="takeoff-form-control" @bind="customer.Website" @bind:event="oninput" @onchange="OnFieldChanged" placeholder="https://example.com" />
                                }
                                else
                                {
                                    @if (!string.IsNullOrEmpty(customer.Website))
                                    {
                                        <p class="takeoff-form-control-plaintext">
                                            <a href="@customer.Website" target="_blank" class="takeoff-text-secondary">
                                                @customer.Website <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </p>
                                    }
                                    else
                                    {
                                        <p class="takeoff-form-control-plaintext">Not provided</p>
                                    }
                                }
                            </div>
                            <div class="takeoff-form-group full-width">
                                <label class="takeoff-form-label">Notes</label>
                                @if (isEditMode)
                                {
                                    <textarea class="takeoff-form-control" rows="3" @bind="customer.Notes" @bind:event="oninput" @onchange="OnFieldChanged" placeholder="Enter notes"></textarea>
                                }
                                else
                                {
                                    @if (!string.IsNullOrEmpty(customer.Notes))
                                    {
                                        <p class="takeoff-form-control-plaintext">@customer.Notes</p>
                                    }
                                    else
                                    {
                                        <p class="takeoff-form-control-plaintext takeoff-text-muted">No notes</p>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact & Location Section -->
                @if (!isNewCustomer)
                {
                    <div class="takeoff-section">
                        <div class="takeoff-section-header @(IsSectionExpanded("contact") ? "expanded" : "")" @onclick="@(() => ToggleSection("contact"))">
                            <div class="section-header-content">
                                <i class="fas fa-address-card section-icon"></i>
                                <span class="section-title">Contact & Location</span>
                            </div>
                            <i class="fas fa-chevron-down section-chevron"></i>
                        </div>
                        <div class="takeoff-section-content @(IsSectionExpanded("contact") ? "expanded" : "collapsed")">
                            <div class="takeoff-form-grid two-column">
                                <!-- Primary Contact Information -->
                                <div class="takeoff-card-info">
                                    <h4 class="info-header"><i class="fas fa-user"></i> Primary Contact</h4>
                                    @if (primaryContact != null)
                                    {
                                        <div class="info-content">
                                            <div class="info-row">
                                                <span class="info-label">Name:</span>
                                                <span class="info-value">@primaryContact.FirstName @primaryContact.LastName</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(primaryContact.Title))
                                            {
                                                <div class="info-row">
                                                    <span class="info-label">Title:</span>
                                                    <span class="info-value">@primaryContact.Title</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(primaryContact.Department))
                                            {
                                                <div class="info-row">
                                                    <span class="info-label">Department:</span>
                                                    <span class="info-value">@primaryContact.Department</span>
                                                </div>
                                            }
                                            <div class="info-row">
                                                <span class="info-label">Email:</span>
                                                <span class="info-value">
                                                    <a href="mailto:@primaryContact.Email" class="takeoff-text-secondary">@primaryContact.Email</a>
                                                </span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(primaryContact.PhoneNumber))
                                            {
                                                <div class="info-row">
                                                    <span class="info-label">Phone:</span>
                                                    <span class="info-value">@primaryContact.PhoneNumber</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(primaryContact.MobileNumber))
                                            {
                                                <div class="info-row">
                                                    <span class="info-label">Mobile:</span>
                                                    <span class="info-value">@primaryContact.MobileNumber</span>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (!string.IsNullOrEmpty(customer.ContactPerson))
                                    {
                                        <!-- Fallback to legacy fields -->
                                        <div class="info-content">
                                            <div class="info-row">
                                                <span class="info-label">Contact:</span>
                                                <span class="info-value">@customer.ContactPerson</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(customer.Email))
                                            {
                                                <div class="info-row">
                                                    <span class="info-label">Email:</span>
                                                    <span class="info-value">
                                                        <a href="mailto:@customer.Email" class="takeoff-text-secondary">@customer.Email</a>
                                                    </span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(customer.PhoneNumber))
                                            {
                                                <div class="info-row">
                                                    <span class="info-label">Phone:</span>
                                                    <span class="info-value">@customer.PhoneNumber</span>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="takeoff-text-muted">No contact information provided</p>
                                    }
                                </div>

                                <!-- Primary Address -->
                                <div class="takeoff-card-info">
                                    <h4 class="info-header"><i class="fas fa-map-marker-alt"></i> Primary Address</h4>
                                    @if (primaryAddress != null)
                                    {
                                        <div class="info-content">
                                            <div class="address-info">
                                                <p>@primaryAddress.AddressLine1</p>
                                                @if (!string.IsNullOrEmpty(primaryAddress.AddressLine2))
                                                {
                                                    <p>@primaryAddress.AddressLine2</p>
                                                }
                                                <p>@primaryAddress.City, @primaryAddress.State @primaryAddress.PostalCode</p>
                                                <p>@primaryAddress.Country</p>
                                            </div>
                                            @if (!string.IsNullOrEmpty(primaryAddress.GooglePlaceId))
                                            {
                                                <button class="btn-link-modern" @onclick="() => ViewOnMap(primaryAddress)">
                                                    <i class="fas fa-map"></i> View on Google Maps
                                                </button>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="takeoff-text-muted">No address provided</p>
                                    }
                                </div>
                            </div>

                            <!-- Additional Contacts -->
                            @if (customer.Contacts?.Count > 1)
                            {
                                <div class="additional-contacts">
                                    <h4 class="info-header"><i class="fas fa-users"></i> Additional Contacts</h4>
                                    <div class="contacts-grid">
                                        @foreach (var contact in customer.Contacts.Where(c => !c.IsPrimary))
                                        {
                                            <div class="contact-item">
                                                <div class="contact-name">
                                                    <strong>@contact.FirstName @contact.LastName</strong>
                                                    @if (!string.IsNullOrEmpty(contact.Title))
                                                    {
                                                        <span class="contact-title">@contact.Title</span>
                                                    }
                                                </div>
                                                <div class="contact-details">
                                                    <a href="mailto:@contact.Email" class="takeoff-text-secondary">@contact.Email</a>
                                                    @if (!string.IsNullOrEmpty(contact.PhoneNumber))
                                                    {
                                                        <span>â€¢ @contact.PhoneNumber</span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Related Trace Drawings Section -->
                    @if (relatedDrawings?.Any() == true)
                    {
                        <div class="takeoff-section">
                            <div class="takeoff-section-header @(IsSectionExpanded("related") ? "expanded" : "")" @onclick="@(() => ToggleSection("related"))">
                                <div class="section-header-content">
                                    <i class="fas fa-file-pdf section-icon"></i>
                                    <span class="section-title">Related Trace Drawings</span>
                                    <span class="takeoff-badge status-default">@relatedDrawings.Count</span>
                                </div>
                                <i class="fas fa-chevron-down section-chevron"></i>
                            </div>
                            <div class="takeoff-section-content @(IsSectionExpanded("related") ? "expanded" : "collapsed")">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Drawing Number</th>
                                                <th>File Name</th>
                                                <th>Project</th>
                                                <th>Upload Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var drawing in relatedDrawings.Take(5))
                                            {
                                                <tr>
                                                    <td>@(drawing.DrawingNumber ?? "-")</td>
                                                    <td>@drawing.FileName</td>
                                                    <td>@(drawing.Project?.ProjectName ?? "-")</td>
                                                    <td>@drawing.UploadDate.ToString("dd/MM/yyyy")</td>
                                                    <td>
                                                        <span class="takeoff-badge status-default">@drawing.ProcessingStatus</span>
                                                    </td>
                                                    <td>
                                                        <button class="btn-icon" title="View" @onclick="() => ViewDrawing(drawing.Id)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                    @if (relatedDrawings.Count > 5)
                                    {
                                        <div class="view-all">
                                            <button class="btn-link-modern" @onclick="ViewAllDrawings">
                                                View all @relatedDrawings.Count drawings <i class="fas fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Activity Timeline Section -->
                    <div class="takeoff-section">
                        <div class="takeoff-section-header @(IsSectionExpanded("activity") ? "expanded" : "")" @onclick="@(() => ToggleSection("activity"))">
                            <div class="section-header-content">
                                <i class="fas fa-clock section-icon"></i>
                                <span class="section-title">Activity</span>
                            </div>
                            <i class="fas fa-chevron-down section-chevron"></i>
                        </div>
                        <div class="takeoff-section-content @(IsSectionExpanded("activity") ? "expanded" : "collapsed")">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <span class="timeline-date">@customer.LastModified.ToString("dd MMM yyyy HH:mm")</span>
                                        <span class="timeline-text">Last modified</span>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-marker"></div>
                                    <div class="timeline-content">
                                        <span class="timeline-date">@customer.CreatedDate.ToString("dd MMM yyyy HH:mm")</span>
                                        <span class="timeline-text">Customer created</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<!-- ABN Lookup Modal -->
@if (showAbnLookupModal)
{
    <div class="modal-overlay" @onclick="CloseAbnLookupModal">
        <div class="abn-lookup-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h4><i class="fas fa-search"></i> ABN Lookup</h4>
                <button class="btn-close" @onclick="CloseAbnLookupModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Search Mode Tabs -->
                <div class="search-tabs">
                    <button class="tab-button @(searchMode == "abn" ? "active" : "")"
                            @onclick="SetAbnSearchMode">
                        <i class="fas fa-hashtag"></i> Search by ABN
                    </button>
                    <button class="tab-button @(searchMode == "name" ? "active" : "")"
                            @onclick="SetNameSearchMode">
                        <i class="fas fa-building"></i> Search by Name
                    </button>
                </div>

                <div class="search-form">
                    @if (searchMode == "abn")
                    {
                        <div class="form-group">
                            <label>ABN Number</label>
                            <div class="input-with-button">
                                <input type="text"
                                       class="form-control"
                                       @bind="abnSearchTerm"
                                       @bind:event="oninput"
                                       @onkeypress="HandleAbnSearchKeyPress"
                                       placeholder="Enter 11-digit ABN"
                                       maxlength="14" />
                                <button type="button"
                                        class="btn btn-primary"
                                        @onclick="SearchByAbn"
                                        disabled="@(isSearching || string.IsNullOrWhiteSpace(abnSearchTerm))">
                                    @if (isSearching)
                                    {
                                        <i class="fas fa-spinner fa-spin"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-search"></i>
                                    }
                                    Search
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="form-group">
                            <label>Business Name</label>
                            <div class="input-with-button">
                                <input type="text"
                                       class="form-control"
                                       @bind="nameSearchTerm"
                                       @bind:event="oninput"
                                       @onkeypress="HandleNameSearchKeyPress"
                                       placeholder="Enter business or trading name" />
                                <button type="button"
                                        class="btn btn-primary"
                                        @onclick="SearchByName"
                                        disabled="@(isSearching || string.IsNullOrWhiteSpace(nameSearchTerm))">
                                    @if (isSearching)
                                    {
                                        <i class="fas fa-spinner fa-spin"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-search"></i>
                                    }
                                    Search
                                </button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>State (Optional)</label>
                                <select class="form-control" @bind="stateFilter">
                                    <option value="">All States</option>
                                    <option value="NSW">NSW</option>
                                    <option value="VIC">VIC</option>
                                    <option value="QLD">QLD</option>
                                    <option value="SA">SA</option>
                                    <option value="WA">WA</option>
                                    <option value="TAS">TAS</option>
                                    <option value="NT">NT</option>
                                    <option value="ACT">ACT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Postcode (Optional)</label>
                                <input type="text"
                                       class="form-control"
                                       @bind="postcodeFilter"
                                       placeholder="e.g. 2000"
                                       maxlength="4" />
                            </div>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(abnErrorMessage))
                {
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        @abnErrorMessage
                    </div>
                }

                <!-- Single Result (ABN Search) -->
                @if (abnSearchResult != null && searchMode == "abn")
                {
                    <div class="search-result">
                        <div class="result-header">
                            <h5>@abnSearchResult.DisplayName</h5>
                            <span class="badge @(abnSearchResult.AbnStatus == "Active" ? "badge-success" : "badge-secondary")">
                                @abnSearchResult.AbnStatus
                            </span>
                        </div>
                        <div class="result-details">
                            <div class="detail-row">
                                <span class="label">ABN:</span>
                                <span class="value">@abnSearchResult.Abn</span>
                            </div>
                            @if (!string.IsNullOrEmpty(abnSearchResult.Acn))
                            {
                                <div class="detail-row">
                                    <span class="label">ACN:</span>
                                    <span class="value">@abnSearchResult.Acn</span>
                                </div>
                            }
                            <div class="detail-row">
                                <span class="label">Entity Type:</span>
                                <span class="value">@abnSearchResult.EntityTypeName</span>
                            </div>
                            @if (!string.IsNullOrEmpty(abnSearchResult.FormattedAddress))
                            {
                                <div class="detail-row">
                                    <span class="label">Address:</span>
                                    <span class="value">@abnSearchResult.FormattedAddress</span>
                                </div>
                            }
                            @if (abnSearchResult.TradingNames.Any())
                            {
                                <div class="detail-row">
                                    <span class="label">Trading Names:</span>
                                    <span class="value">@string.Join(", ", abnSearchResult.TradingNames)</span>
                                </div>
                            }
                        </div>
                        <div class="result-actions">
                            <button class="btn btn-primary" @onclick="() => SelectResult(abnSearchResult)">
                                <i class="fas fa-check"></i>
                                Use This Information
                            </button>
                        </div>
                    </div>
                }

                <!-- Multiple Results (Name Search) -->
                @if (nameSearchResults != null && nameSearchResults.Any() && searchMode == "name")
                {
                    <div class="results-header">
                        <h6>Found @nameSearchResults.Count result(s)</h6>
                    </div>
                    <div class="results-list">
                        @foreach (var result in nameSearchResults)
                        {
                            <div class="result-card" @onclick="() => SelectResult(result)">
                                <div class="result-card-header">
                                    <div class="result-card-title">
                                        <strong>@result.DisplayName</strong>
                                        <span class="badge-small @(result.AbnStatus == "Active" ? "badge-success" : "badge-secondary")">
                                            @result.AbnStatus
                                        </span>
                                    </div>
                                    <div class="result-card-meta">
                                        <span class="abn-number">ABN: @result.Abn</span>
                                        @if (!string.IsNullOrEmpty(result.State))
                                        {
                                            <span class="state-badge">@result.State</span>
                                        }
                                    </div>
                                </div>
                                @if (result.TradingNames.Any())
                                {
                                    <div class="result-card-trading">
                                        <i class="fas fa-tag"></i> @string.Join(", ", result.TradingNames)
                                    </div>
                                }
                                <div class="result-card-action">
                                    <i class="fas fa-chevron-right"></i>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (nameSearchResults != null && !nameSearchResults.Any() && searchMode == "name" && !isSearching)
                {
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        No businesses found matching "@nameSearchTerm". Try adjusting your search terms or filters.
                    </div>
                }
            </div>
        </div>
    </div>
}

<!-- Unsaved Changes Confirmation Dialog -->
@if (showUnsavedChangesDialog)
{
    <div class="modal-overlay" @onclick="StayOnPage">
        <div class="confirmation-dialog" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <h4>Unsaved Changes</h4>
            </div>
            <div class="dialog-body">
                <p>You have unsaved changes. @(isNewCustomer ? "The customer will not be created." : "Your changes will be lost.")</p>
                <p>Are you sure you want to leave this page?</p>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-primary" @onclick="StayOnPage">
                    <i class="fas fa-check"></i>
                    Stay on Page
                </button>
                <button class="btn btn-secondary" @onclick="LeaveWithoutSaving">
                    <i class="fas fa-times"></i>
                    Leave Without Saving
                </button>
            </div>
        </div>
    </div>
}

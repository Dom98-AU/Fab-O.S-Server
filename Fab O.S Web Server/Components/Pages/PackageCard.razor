@page "/packages/{Id:int}"
@rendermode InteractiveServer
@using FabOS.WebServer.Components.Shared
@using FabOS.WebServer.Components.Shared.Interfaces
@using FabOS.WebServer.Data.Contexts
@using FabOS.WebServer.Models.Entities
@using Microsoft.EntityFrameworkCore

<PageTitle>@(Id == 0 ? "New Package" : package?.PackageNumber ?? "Package Details") - Fab.OS</PageTitle>

<!-- Standard Toolbar -->
<StandardToolbar ActionProvider="@this" PageType="PageType.Card" />

<!-- Main Content Container -->
<div class="package-layout">
    @if (isLoading)
    {
        <!-- Loading State -->
        <div class="package-loading">
            <div class="package-spinner"></div>
            <p>Loading package details...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <!-- Error State -->
        <div class="package-error">
            <i class="fas fa-exclamation-triangle"></i>
            <div>@errorMessage</div>
        </div>
    }
    else if (package != null)
    {
        <!-- Container Wrapper -->
        <div class="package-container">
            <!-- Collapsible Sections -->
            <div class="package-sections">

                <!-- General Section (Basic Info) -->
                <div class="package-section">
                    <div class="package-section-header @(IsSectionExpanded("general") ? "expanded" : "")" @onclick="@(() => ToggleSection("general"))">
                        <div class="section-header-content">
                            <i class="fas fa-info-circle section-icon"></i>
                            <span class="section-title">General</span>
                        </div>
                        <i class="fas fa-chevron-down section-chevron"></i>
                    </div>
                    <div class="package-section-content @(IsSectionExpanded("general") ? "expanded" : "collapsed")">
                        <div class="package-form-grid two-column">
                            <!-- Package Number (Auto-generated) -->
                            <div class="package-form-group">
                                <label class="package-form-label">Package Number</label>
                                @if (isEditMode && package.Id == 0)
                                {
                                    <input type="text" class="package-form-control" value="@package.PackageNumber"
                                           placeholder="Will be auto-generated on save" readonly />
                                }
                                else
                                {
                                    <p class="package-form-control-plaintext">@(package.PackageNumber ?? "Not set")</p>
                                }
                        </div>

                            <!-- Package Name -->
                            <div class="package-form-group">
                                <label class="package-form-label">Package Name</label>
                                @if (isEditMode)
                                {
                                    <input type="text" class="package-form-control" @bind="package.PackageName"
                                           placeholder="Enter package name" />
                                }
                                else
                                {
                                    <p class="package-form-control-plaintext">@(package.PackageName ?? "Not set")</p>
                                }
                        </div>

                            <!-- Description -->
                            <div class="package-form-group full-width">
                                <label class="package-form-label">Description</label>
                                @if (isEditMode)
                                {
                                    <textarea class="package-form-control" rows="3" @bind="package.Description"
                                              placeholder="Enter package description"></textarea>
                                }
                                else
                                {
                                    <p class="package-form-control-plaintext">@(package.Description ?? "No description")</p>
                                }
                        </div>

                            <!-- Status -->
                            <div class="package-form-group">
                                <label class="package-form-label">Status</label>
                                @if (isEditMode)
                                {
                                    <select class="package-form-control" @bind="package.Status">
                                        <option value="Planning">Planning</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Review">Review</option>
                                        <option value="Complete">Complete</option>
                                        <option value="On Hold">On Hold</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                }
                                else
                                {
                                    <p class="package-form-control-plaintext">
                                        <span class="package-badge @GetStatusBadgeClass(package.Status)">
                                            @(package.Status ?? "Not set")
                                        </span>
                                    </p>
                                }
                        </div>

                            <!-- Package Source -->
                            <div class="package-form-group">
                                <label class="package-form-label">Package Source</label>
                                @if (isEditMode)
                                {
                                    <select class="package-form-control" @bind="package.PackageSource">
                                        <option value="Project">Project</option>
                                        <option value="Takeoff">Takeoff</option>
                                        <option value="Estimation">Estimation</option>
                                        <option value="Order">Order</option>
                                    </select>
                                }
                                else
                                {
                                    <p class="package-form-control-plaintext">@(package.PackageSource ?? "Project")</p>
                                }
                            </div>
                        </div> <!-- End of form-grid -->
                    </div> <!-- End of General section content -->
                </div> <!-- End of General section -->

                <!-- Schedule & Costing Section -->
                <div class="package-section">
                    <div class="package-section-header @(IsSectionExpanded("schedule") ? "expanded" : "")" @onclick="@(() => ToggleSection("schedule"))">
                        <div class="section-header-content">
                            <i class="fas fa-calendar-alt section-icon"></i>
                            <span class="section-title">Schedule & Costing</span>
                        </div>
                        <i class="fas @(IsSectionExpanded("schedule") ? "fa-chevron-up" : "fa-chevron-down") toggle-icon"></i>
                    </div>

                    @if (IsSectionExpanded("schedule"))
                    {
                        <div class="package-section-content">
                            <div class="package-form-grid two-column">
                        <!-- Start Date -->
                        <div class="package-form-group">
                            <label class="package-form-label">Start Date</label>
                            @if (isEditMode)
                            {
                                <input type="date" class="package-form-control" @bind="package.StartDate" />
                            }
                            else
                            {
                                <p class="package-form-control-plaintext">@(package.StartDate?.ToString("MMM dd, yyyy") ?? "Not set")</p>
                            }
                        </div>

                        <!-- End Date -->
                        <div class="package-form-group">
                            <label class="package-form-label">End Date</label>
                            @if (isEditMode)
                            {
                                <input type="date" class="package-form-control" @bind="package.EndDate" />
                            }
                            else
                            {
                                <p class="package-form-control-plaintext">@(package.EndDate?.ToString("MMM dd, yyyy") ?? "Not set")</p>
                            }
                        </div>

                        <!-- Estimated Hours -->
                        <div class="package-form-group">
                            <label class="package-form-label">Estimated Hours</label>
                            @if (isEditMode)
                            {
                                <input type="number" class="package-form-control" @bind="package.EstimatedHours" step="0.01" />
                            }
                            else
                            {
                                <p class="package-form-control-plaintext">@package.EstimatedHours.ToString("N2")</p>
                            }
                        </div>

                        <!-- Estimated Cost -->
                        <div class="package-form-group">
                            <label class="package-form-label">Estimated Cost</label>
                            @if (isEditMode)
                            {
                                <input type="number" class="package-form-control" @bind="package.EstimatedCost" step="0.01" />
                            }
                            else
                            {
                                <p class="package-form-control-plaintext">$@package.EstimatedCost.ToString("N2")</p>
                            }
                        </div>

                        <!-- Actual Hours -->
                        <div class="package-form-group">
                            <label class="package-form-label">Actual Hours</label>
                            @if (isEditMode)
                            {
                                <input type="number" class="package-form-control" @bind="package.ActualHours" step="0.01" />
                            }
                            else
                            {
                                <p class="package-form-control-plaintext">@package.ActualHours.ToString("N2")</p>
                            }
                        </div>

                        <!-- Actual Cost -->
                        <div class="package-form-group">
                            <label class="package-form-label">Actual Cost</label>
                            @if (isEditMode)
                            {
                                <input type="number" class="package-form-control" @bind="package.ActualCost" step="0.01" />
                            }
                            else
                            {
                                <p class="package-form-control-plaintext">$@package.ActualCost.ToString("N2")</p>
                            }
                        </div>

                                <!-- Labor Rate per Hour -->
                                <div class="package-form-group">
                                    <label class="package-form-label">Labor Rate per Hour</label>
                                    @if (isEditMode)
                                    {
                                        <input type="number" class="package-form-control" @bind="package.LaborRatePerHour" step="0.01" />
                                    }
                                    else
                                    {
                                        <p class="package-form-control-plaintext">$@package.LaborRatePerHour.ToString("N2")</p>
                                    }
                                </div>

                                <!-- Processing Efficiency -->
                                <div class="package-form-group">
                                    <label class="package-form-label">Processing Efficiency (%)</label>
                                    @if (isEditMode)
                                    {
                                        <input type="number" class="package-form-control" @bind="package.ProcessingEfficiency" step="0.1" min="0" max="200" />
                                    }
                                    else
                                    {
                                        <p class="package-form-control-plaintext">@((package.ProcessingEfficiency ?? 100m).ToString("N1"))%</p>
                                    }
                                </div>
                            </div> <!-- End of form-grid -->
                        </div> <!-- End of Schedule section content -->
                    }
                </div> <!-- End of Schedule section -->

                <!-- Related Section -->
                <div class="package-section">
                    <div class="package-section-header @(IsSectionExpanded("related") ? "expanded" : "")" @onclick="@(() => ToggleSection("related"))">
                        <div class="section-header-content">
                            <i class="fas fa-link section-icon"></i>
                            <span class="section-title">Related</span>
                        </div>
                        <i class="fas @(IsSectionExpanded("related") ? "fa-chevron-up" : "fa-chevron-down") toggle-icon"></i>
                    </div>

                    @if (IsSectionExpanded("related"))
                    {
                        <div class="package-section-content">
                            <div class="related-links">
                                <button class="related-link-button" @onclick="NavigateToTakeoffs">
                                    <div class="link-icon">
                                        <i class="fas fa-ruler"></i>
                                    </div>
                                    <div class="link-content">
                                        <span class="link-title">Package Takeoffs</span>
                                        <span class="link-description">View and manage takeoffs for this package</span>
                                    </div>
                                    <div class="link-arrow">
                                        <i class="fas fa-arrow-right"></i>
                                    </div>
                                </button>
                            </div>
                        </div>
                    }
                </div> <!-- End of Related section -->

            </div> <!-- End of package-sections -->
        </div> <!-- End of package-container -->
    }
    else
    {
        <!-- No Data State -->
        <div class="package-error">
            <i class="fas fa-exclamation-triangle"></i>
            <div>No package found</div>
        </div>
    }
</div>

@code {
    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "planning" => "status-planning",
            "in progress" => "status-progress",
            "review" => "status-review",
            "complete" => "status-complete",
            "on hold" => "status-hold",
            "cancelled" => "status-cancelled",
            _ => "status-default"
        };
    }
}
@page "/settings/global"
@rendermode InteractiveServer
@using FabOS.WebServer.Services.Interfaces
@using FabOS.WebServer.Models.Entities
@inject ISettingsService SettingsService
@inject ILogger<GlobalSettings> Logger

<PageTitle>Global Settings - Fab.OS</PageTitle>

<div class="settings-container">
    <div class="settings-header">
        <h1>Global Settings</h1>
        <p class="settings-description">Platform-wide configuration settings that affect all modules</p>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            @successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            @errorMessage
        </div>
    }

    <div class="settings-content">
        <!-- System Settings -->
        <div class="settings-section">
            <h2 class="section-title">System Settings</h2>
            <div class="settings-grid">
                @foreach (var setting in systemSettings)
                {
                    <div class="setting-item">
                        <label class="setting-label">@setting.SettingKey.Replace("System.", "")</label>
                        <div class="setting-input-group">
                            <input type="text" class="setting-input"
                                   value="@setting.SettingValue"
                                   @onchange="@((e) => UpdateSetting(setting, e.Value?.ToString()))"
                                   disabled="@(setting.IsSystemSetting && !isEditMode)" />
                            @if (!string.IsNullOrEmpty(setting.Description))
                            {
                                <small class="setting-description">@setting.Description</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Security Settings -->
        <div class="settings-section">
            <h2 class="section-title">Security Settings</h2>
            <div class="settings-grid">
                @foreach (var setting in securitySettings)
                {
                    <div class="setting-item">
                        <label class="setting-label">@setting.SettingKey.Replace("Security.", "")</label>
                        <div class="setting-input-group">
                            <input type="text" class="setting-input"
                                   value="@setting.SettingValue"
                                   @onchange="@((e) => UpdateSetting(setting, e.Value?.ToString()))"
                                   disabled="@(setting.IsSystemSetting && !isEditMode)" />
                            @if (!string.IsNullOrEmpty(setting.Description))
                            {
                                <small class="setting-description">@setting.Description</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Display Settings -->
        <div class="settings-section">
            <h2 class="section-title">Display Settings</h2>
            <div class="settings-grid">
                @foreach (var setting in displaySettings)
                {
                    <div class="setting-item">
                        <label class="setting-label">@setting.SettingKey.Replace("Display.", "")</label>
                        <div class="setting-input-group">
                            <input type="text" class="setting-input"
                                   value="@setting.SettingValue"
                                   @onchange="@((e) => UpdateSetting(setting, e.Value?.ToString()))"
                                   disabled="@(setting.IsSystemSetting && !isEditMode)" />
                            @if (!string.IsNullOrEmpty(setting.Description))
                            {
                                <small class="setting-description">@setting.Description</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Add New Setting -->
        <div class="settings-section">
            <h2 class="section-title">Add New Setting</h2>
            <div class="add-setting-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-control" @bind="newSettingCategory">
                            <option value="">Select Category</option>
                            <option value="System">System</option>
                            <option value="Security">Security</option>
                            <option value="Display">Display</option>
                            <option value="Integration">Integration</option>
                            <option value="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Setting Key</label>
                        <input type="text" class="form-control" @bind="newSettingKey" placeholder="e.g., MaxFileSize" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Value</label>
                        <input type="text" class="form-control" @bind="newSettingValue" placeholder="Setting value" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" @bind="newSettingDescription" placeholder="Description (optional)" />
                    </div>
                </div>
                <button class="btn btn-primary" @onclick="AddNewSetting">Add Setting</button>
            </div>
        </div>
    </div>

    <div class="settings-footer">
        @if (!isEditMode)
        {
            <button class="btn btn-secondary" @onclick="EnableEditMode">Enable System Settings Edit</button>
        }
        else
        {
            <button class="btn btn-warning" @onclick="DisableEditMode">Disable System Settings Edit</button>
        }
        <button class="btn btn-primary" @onclick="SaveAllChanges">Save All Changes</button>
    </div>
</div>

<style>
    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .settings-header {
        margin-bottom: 2rem;
        border-bottom: 2px solid #0284c7;
        padding-bottom: 1rem;
    }

    .settings-header h1 {
        font-size: 2rem;
        color: #1e40af;
        margin: 0;
    }

    .settings-description {
        color: #6b7280;
        margin-top: 0.5rem;
    }

    .settings-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .settings-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 1.25rem;
        color: #374151;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .setting-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }

    .setting-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .setting-input {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.95rem;
        transition: border-color 0.2s;
    }

    .setting-input:focus {
        outline: none;
        border-color: #0284c7;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }

    .setting-input:disabled {
        background-color: #f3f4f6;
        cursor: not-allowed;
    }

    .setting-description {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .add-setting-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .form-group label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }

    .form-control {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.95rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #0284c7;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }

    .settings-footer {
        margin-top: 2rem;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e5e7eb;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: #0284c7;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0369a1;
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
    }

    .btn-warning {
        background-color: #f59e0b;
        color: white;
    }

    .btn-warning:hover {
        background-color: #d97706;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .alert-danger {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }
</style>

@code {
    private List<FabOS.WebServer.Models.Entities.GlobalSettings> allSettings = new();
    private List<FabOS.WebServer.Models.Entities.GlobalSettings> systemSettings = new();
    private List<FabOS.WebServer.Models.Entities.GlobalSettings> securitySettings = new();
    private List<FabOS.WebServer.Models.Entities.GlobalSettings> displaySettings = new();

    private Dictionary<string, string> pendingChanges = new();
    private string successMessage = "";
    private string errorMessage = "";
    private bool isEditMode = false;

    // New setting form fields
    private string newSettingCategory = "";
    private string newSettingKey = "";
    private string newSettingValue = "";
    private string newSettingDescription = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            allSettings = await SettingsService.GetAllGlobalSettingsAsync();

            systemSettings = allSettings.Where(s => s.Category == "System").ToList();
            securitySettings = allSettings.Where(s => s.Category == "Security").ToList();
            displaySettings = allSettings.Where(s => s.Category == "Display").ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load global settings");
            errorMessage = "Failed to load settings. Please try again.";
        }
    }

    private void UpdateSetting(FabOS.WebServer.Models.Entities.GlobalSettings setting, string? newValue)
    {
        if (newValue != null && newValue != setting.SettingValue)
        {
            pendingChanges[setting.SettingKey] = newValue;
            setting.SettingValue = newValue;
        }
    }

    private async Task SaveAllChanges()
    {
        try
        {
            foreach (var change in pendingChanges)
            {
                await SettingsService.SetGlobalSettingAsync(change.Key, change.Value);
            }

            pendingChanges.Clear();
            successMessage = "Settings saved successfully!";
            errorMessage = "";

            // Clear message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                successMessage = "";
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save settings");
            errorMessage = "Failed to save settings. Please try again.";
        }
    }

    private async Task AddNewSetting()
    {
        if (string.IsNullOrWhiteSpace(newSettingCategory) ||
            string.IsNullOrWhiteSpace(newSettingKey) ||
            string.IsNullOrWhiteSpace(newSettingValue))
        {
            errorMessage = "Please fill in all required fields.";
            return;
        }

        try
        {
            var fullKey = $"{newSettingCategory}.{newSettingKey}";
            await SettingsService.SetGlobalSettingAsync(fullKey, newSettingValue, newSettingCategory, newSettingDescription);

            // Clear form
            newSettingCategory = "";
            newSettingKey = "";
            newSettingValue = "";
            newSettingDescription = "";

            // Reload settings
            await LoadSettings();

            successMessage = "New setting added successfully!";
            errorMessage = "";

            // Clear message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                successMessage = "";
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add new setting");
            errorMessage = "Failed to add new setting. Please try again.";
        }
    }

    private void EnableEditMode()
    {
        isEditMode = true;
    }

    private void DisableEditMode()
    {
        isEditMode = false;
    }
}
@page "/settings/trace"
@rendermode InteractiveServer
@using FabOS.WebServer.Services
@using FabOS.WebServer.Services.Interfaces
@using FabOS.WebServer.Models.Entities
@using FabOS.WebServer.Data.Contexts
@using Microsoft.EntityFrameworkCore
@inject ISettingsService SettingsService
@inject NumberSeriesService NumberSeriesService
@inject ApplicationDbContext Context
@inject ILogger<TraceSettings> Logger

<PageTitle>Trace Module Settings - Fab.OS</PageTitle>

<div class="settings-container">
    <div class="settings-header">
        <h1>Trace Module Settings</h1>
        <p class="settings-description">Configure settings specific to the Trace module including takeoff numbering</p>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">
            @successMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            @errorMessage
        </div>
    }

    <div class="settings-content">
        <!-- Number Series Configuration -->
        <div class="settings-section">
            <h2 class="section-title">Takeoff Number Series</h2>
            <div class="number-series-form">
                @if (takeoffNumberSeries != null)
                {
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Prefix</label>
                            <input type="text" class="form-control" @bind="takeoffNumberSeries.Prefix" placeholder="e.g., TO-" />
                            <small class="help-text">Optional prefix for takeoff numbers</small>
                        </div>
                        <div class="form-group">
                            <label>Starting Number</label>
                            <input type="number" class="form-control" @bind="takeoffNumberSeries.StartingNumber" min="1" />
                            <small class="help-text">First number in the series</small>
                        </div>
                        <div class="form-group">
                            <label>Current Number</label>
                            <input type="number" class="form-control" @bind="takeoffNumberSeries.CurrentNumber" readonly />
                            <small class="help-text">Next number to be assigned</small>
                        </div>
                        <div class="form-group">
                            <label>Minimum Digits</label>
                            <input type="number" class="form-control" @bind="takeoffNumberSeries.MinDigits" min="1" max="10" />
                            <small class="help-text">Pad numbers with zeros (e.g., 4 = 0001)</small>
                        </div>
                        <div class="form-group">
                            <label>Suffix</label>
                            <input type="text" class="form-control" @bind="takeoffNumberSeries.Suffix" placeholder="e.g., -2024" />
                            <small class="help-text">Optional suffix for takeoff numbers</small>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="takeoffNumberSeries.IncludeYear" />
                            Include Year in Number
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="takeoffNumberSeries.IncludeMonth" />
                            Include Month in Number
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="takeoffNumberSeries.IsActive" />
                            Active
                        </label>
                    </div>

                    <div class="preview-section">
                        <h3>Preview</h3>
                        <div class="preview-box">
                            Next Takeoff Number: <strong>@GetPreviewNumber()</strong>
                        </div>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" @onclick="SaveNumberSeries">Save Number Series Settings</button>
                        <button class="btn btn-secondary" @onclick="ResetNumberSeries">Reset to Defaults</button>
                    </div>
                }
                else
                {
                    <p>Loading number series configuration...</p>
                }
            </div>
        </div>

        <!-- Module Specific Settings -->
        <div class="settings-section">
            <h2 class="section-title">Trace Module Preferences</h2>
            <div class="settings-grid">
                @foreach (var setting in moduleSettings)
                {
                    <div class="setting-item">
                        <label class="setting-label">@GetFriendlyName(setting.SettingKey)</label>
                        <div class="setting-input-group">
                            <input type="text" class="setting-input"
                                   value="@setting.SettingValue"
                                   @onchange="@((e) => UpdateModuleSetting(setting, e.Value?.ToString()))" />
                            @if (!string.IsNullOrEmpty(setting.Description))
                            {
                                <small class="setting-description">@setting.Description</small>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Add New Module Setting -->
        <div class="settings-section">
            <h2 class="section-title">Add Module Setting</h2>
            <div class="add-setting-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Setting Key</label>
                        <input type="text" class="form-control" @bind="newSettingKey" placeholder="e.g., DefaultScale" />
                    </div>
                    <div class="form-group">
                        <label>Value</label>
                        <input type="text" class="form-control" @bind="newSettingValue" placeholder="Setting value" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" @bind="newSettingDescription" placeholder="Description (optional)" />
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" @onclick="AddNewModuleSetting">Add Setting</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .settings-header {
        margin-bottom: 2rem;
        border-bottom: 2px solid #0284c7;
        padding-bottom: 1rem;
    }

    .settings-header h1 {
        font-size: 2rem;
        color: #1e40af;
        margin: 0;
    }

    .settings-description {
        color: #6b7280;
        margin-top: 0.5rem;
    }

    .settings-content {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .settings-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 1.25rem;
        color: #374151;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }

    .number-series-form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .form-group label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }

    .form-control {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.95rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #0284c7;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }

    .help-text {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .checkbox-group {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #374151;
        cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .preview-section {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #f0f9ff;
        border: 1px solid #0284c7;
        border-radius: 4px;
    }

    .preview-section h3 {
        margin: 0 0 0.5rem 0;
        color: #0369a1;
        font-size: 1rem;
    }

    .preview-box {
        font-size: 1.1rem;
        color: #374151;
    }

    .preview-box strong {
        color: #0284c7;
        font-size: 1.25rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .setting-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.9rem;
    }

    .setting-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .setting-input {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 0.95rem;
    }

    .setting-input:focus {
        outline: none;
        border-color: #0284c7;
        box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }

    .setting-description {
        color: #6b7280;
        font-size: 0.8rem;
    }

    .add-setting-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: #0284c7;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0369a1;
    }

    .btn-secondary {
        background-color: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
    }

    .alert {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .alert-danger {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }
</style>

@code {
    private FabOS.WebServer.Models.Entities.NumberSeries? takeoffNumberSeries;
    private List<FabOS.WebServer.Models.Entities.ModuleSettings> moduleSettings = new();
    private Dictionary<string, string> pendingModuleChanges = new();

    private string successMessage = "";
    private string errorMessage = "";

    // New setting form fields
    private string newSettingKey = "";
    private string newSettingValue = "";
    private string newSettingDescription = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            // Load number series for takeoffs
            takeoffNumberSeries = await Context.NumberSeries
                .FirstOrDefaultAsync(ns => ns.EntityType == "Takeoff" && ns.CompanyId == 1);

            if (takeoffNumberSeries == null)
            {
                // Create default if not exists
                takeoffNumberSeries = new FabOS.WebServer.Models.Entities.NumberSeries
                {
                    EntityType = "Takeoff",
                    CompanyId = 1,
                    Prefix = "TO-",
                    Suffix = "",
                    StartingNumber = 1,
                    CurrentNumber = 1,
                    MinDigits = 4,
                    IncludeYear = false,
                    IncludeMonth = false,
                    IsActive = true
                };
                Context.NumberSeries.Add(takeoffNumberSeries);
                await Context.SaveChangesAsync();
            }

            // Load module settings
            moduleSettings = await SettingsService.GetModuleSettingsByModuleAsync("Trace");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load settings");
            errorMessage = "Failed to load settings. Please try again.";
        }
    }

    private string GetPreviewNumber()
    {
        if (takeoffNumberSeries == null) return "N/A";

        var preview = takeoffNumberSeries.Prefix ?? "";
        if (takeoffNumberSeries.IncludeYear)
        {
            preview += DateTime.Now.Year.ToString();
            if (takeoffNumberSeries.IncludeMonth) preview += "-";
        }
        if (takeoffNumberSeries.IncludeMonth)
        {
            preview += DateTime.Now.ToString("MM");
            preview += "-";
        }
        preview += takeoffNumberSeries.CurrentNumber.ToString().PadLeft(takeoffNumberSeries.MinDigits, '0');
        preview += takeoffNumberSeries.Suffix ?? "";
        return preview;
    }

    private async Task SaveNumberSeries()
    {
        try
        {
            if (takeoffNumberSeries != null)
            {
                Context.NumberSeries.Update(takeoffNumberSeries);
                await Context.SaveChangesAsync();

                successMessage = "Number series settings saved successfully!";
                errorMessage = "";

                // Clear message after 3 seconds
                _ = Task.Delay(3000).ContinueWith(_ =>
                {
                    successMessage = "";
                    InvokeAsync(StateHasChanged);
                });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save number series");
            errorMessage = "Failed to save number series settings. Please try again.";
        }
    }

    private async Task ResetNumberSeries()
    {
        if (takeoffNumberSeries != null)
        {
            takeoffNumberSeries.Prefix = "TO-";
            takeoffNumberSeries.Suffix = "";
            takeoffNumberSeries.StartingNumber = 1;
            takeoffNumberSeries.CurrentNumber = 1;
            takeoffNumberSeries.MinDigits = 4;
            takeoffNumberSeries.IncludeYear = false;
            takeoffNumberSeries.IncludeMonth = false;
            takeoffNumberSeries.IsActive = true;

            await SaveNumberSeries();
        }
    }

    private void UpdateModuleSetting(FabOS.WebServer.Models.Entities.ModuleSettings setting, string? newValue)
    {
        if (newValue != null && newValue != setting.SettingValue)
        {
            pendingModuleChanges[setting.SettingKey] = newValue;
            setting.SettingValue = newValue;
        }
    }

    private async Task SaveModuleSettings()
    {
        try
        {
            foreach (var change in pendingModuleChanges)
            {
                await SettingsService.SetModuleSettingAsync("Trace", change.Key, change.Value);
            }

            pendingModuleChanges.Clear();
            successMessage = "Module settings saved successfully!";
            errorMessage = "";

            // Clear message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                successMessage = "";
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save module settings");
            errorMessage = "Failed to save module settings. Please try again.";
        }
    }

    private async Task AddNewModuleSetting()
    {
        if (string.IsNullOrWhiteSpace(newSettingKey) || string.IsNullOrWhiteSpace(newSettingValue))
        {
            errorMessage = "Please fill in all required fields.";
            return;
        }

        try
        {
            await SettingsService.SetModuleSettingAsync("Trace", newSettingKey, newSettingValue, null, newSettingDescription);

            // Clear form
            newSettingKey = "";
            newSettingValue = "";
            newSettingDescription = "";

            // Reload settings
            moduleSettings = await SettingsService.GetModuleSettingsByModuleAsync("Trace");

            successMessage = "New setting added successfully!";
            errorMessage = "";

            // Clear message after 3 seconds
            _ = Task.Delay(3000).ContinueWith(_ =>
            {
                successMessage = "";
                InvokeAsync(StateHasChanged);
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add new setting");
            errorMessage = "Failed to add new setting. Please try again.";
        }
    }

    private string GetFriendlyName(string settingKey)
    {
        // Convert camelCase or PascalCase to friendly name
        return System.Text.RegularExpressions.Regex.Replace(settingKey, "([a-z])([A-Z])", "$1 $2");
    }
}
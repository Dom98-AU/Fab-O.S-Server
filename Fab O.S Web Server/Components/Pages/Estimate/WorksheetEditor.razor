@*
═══════════════════════════════════════════════════════════════
EDITOR-TYPE PAGE
═══════════════════════════════════════════════════════════════
Page Type: Editor
Entity: EstimationWorksheet
Features: Editable grid, formulas, column management, row operations
Pattern: Spreadsheet-like
Module: Estimate
Last Updated: 2025-12-09
═══════════════════════════════════════════════════════════════
*@
@page "/{tenantSlug}/estimate/worksheets/{id:int}"
@rendermode InteractiveServer
@using FabOS.WebServer.Components.Shared
@using FabOS.WebServer.Components.Shared.Interfaces
@using FabOS.WebServer.Components.Pages.Estimate.Components
@using FabOS.WebServer.Data.Contexts
@using FabOS.WebServer.Models.Entities
@using FabOS.WebServer.Models
@using Microsoft.EntityFrameworkCore
@using System.Text.Json

<PageTitle>@(worksheet?.Name ?? "Worksheet") - Fab.OS</PageTitle>

<!-- Standard Toolbar -->
<StandardToolbar ActionProvider="@this" ShowSearch="false" PageType="PageType.Card" />

<!-- Content -->
<div class="worksheet-editor-container">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading worksheet...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            @errorMessage
        </div>
    }
    else if (worksheet != null)
    {
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/@TenantSlug/estimate/estimations">Estimations</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="/@TenantSlug/estimate/estimations/@(worksheet.EstimationRevisionPackage?.EstimationRevision?.EstimationId)">
                        @(worksheet.EstimationRevisionPackage?.EstimationRevision?.Estimation?.Name ?? "Estimation")
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="/@TenantSlug/estimate/packages/@(worksheet.EstimationRevisionPackageId)">
                        @(worksheet.EstimationRevisionPackage?.PackageName ?? "Package")
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">@worksheet.Name</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h3 class="mb-1">@worksheet.Name</h3>
                <span class="badge @GetWorksheetTypeBadgeClass(worksheet.WorksheetType) me-2">@worksheet.WorksheetType</span>
                <span class="text-muted">@visibleColumns.Count columns, @dataRows.Count rows</span>
                @{
                    var unmatchedCount = GetUnmatchedRowCount();
                }
                @if (unmatchedCount > 0)
                {
                    <span class="badge bg-warning text-dark ms-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>@unmatchedCount unmatched
                    </span>
                }
            </div>
            <div class="d-flex gap-2">
                @if (unmatchedCount > 0 && isDraft)
                {
                    <button class="btn btn-warning btn-sm" @onclick="ReviewUnmatchedRows">
                        <i class="fas fa-search me-1"></i>Review Unmatched
                    </button>
                }
                @if (isDraft)
                {
                    <button class="btn btn-outline-primary btn-sm" @onclick="AddRow">
                        <i class="fas fa-plus me-1"></i>Add Row
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="() => showColumnManager = true">
                        <i class="fas fa-columns me-1"></i>Columns
                    </button>
                }
                <button class="btn btn-outline-info btn-sm" @onclick="RecalculateWorksheet">
                    <i class="fas fa-calculator me-1"></i>Recalculate
                </button>
            </div>
        </div>

        <!-- Worksheet Grid -->
        <div class="worksheet-grid-container">
            <div class="table-responsive worksheet-table-wrapper">
                <table class="table table-bordered table-hover worksheet-table">
                    <thead class="table-dark sticky-top">
                        <tr>
                            @if (isDraft)
                            {
                                <th style="width: 40px;" class="text-center">
                                    <input type="checkbox" class="form-check-input" @bind="selectAllRows" @bind:after="OnSelectAllRowsChanged" />
                                </th>
                            }
                            <th style="width: 50px;" class="text-center">#</th>
                            @foreach (var column in visibleColumns)
                            {
                                <th style="width: @(column.Width)px; min-width: @(column.Width)px;"
                                    class="@(column.IsFrozen ? "frozen-column" : "")">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>@column.DisplayName</span>
                                        @if (!string.IsNullOrEmpty(column.Formula))
                                        {
                                            <i class="fas fa-function text-info ms-1" title="Computed: @column.Formula"></i>
                                        }
                                        @if (column.LinkToCatalogue)
                                        {
                                            <i class="fas fa-book text-success ms-1" title="Linked to Catalogue: @column.CatalogueField"></i>
                                        }
                                    </div>
                                </th>
                            }
                            @if (isDraft)
                            {
                                <th style="width: 80px;" class="text-center">Actions</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in dataRows)
                        {
                            @if (row.IsGroupHeader)
                            {
                                var groupName = GetCellValue(row, "group_name")?.ToString() ?? GetCellValue(row, "description")?.ToString() ?? "Group";
                                <tr class="table-secondary group-header-row">
                                    @if (isDraft)
                                    {
                                        <td></td>
                                    }
                                    <td colspan="@(visibleColumns.Count + 2)" class="fw-bold">
                                        <i class="fas fa-folder me-2"></i>@groupName
                                    </td>
                                </tr>
                            }
                            else
                            {
                                var isUnmatched = row.MatchStatus == "Unmatched";
                                var rowClass = selectedRows.Contains(row.Id) ? "table-primary" : (isUnmatched ? "table-warning" : "");

                                <tr class="@rowClass">
                                    @if (isDraft)
                                    {
                                        <td class="text-center" @onclick:stopPropagation="true">
                                            <input type="checkbox" class="form-check-input"
                                                   checked="@selectedRows.Contains(row.Id)"
                                                   @onchange="() => ToggleRowSelection(row.Id)" />
                                        </td>
                                    }
                                    <td class="text-center text-muted">
                                        @row.RowNumber
                                        @if (isUnmatched)
                                        {
                                            <i class="fas fa-exclamation-circle text-warning ms-1" title="Unmatched - click to assign catalogue item"></i>
                                        }
                                        else if (row.MatchStatus == "Matched" || row.MatchStatus == "ManuallyAssigned")
                                        {
                                            <i class="fas fa-check-circle text-success ms-1" title="Matched to catalogue"></i>
                                        }
                                    </td>
                                    @foreach (var column in visibleColumns)
                                    {
                                        var cellValue = GetCellValue(row, column.ColumnKey);
                                        var isComputed = !string.IsNullOrEmpty(column.Formula);
                                        var isCatalogueLinked = column.LinkToCatalogue && column.AutoPopulateFromCatalogue;
                                        var isReadOnly = !column.IsEditable || isComputed || isCatalogueLinked;

                                        <td class="@(column.IsFrozen ? "frozen-column" : "") @(isComputed ? "computed-cell" : "") @(isCatalogueLinked ? "catalogue-cell" : "")">
                                            @if (isDraft && !isReadOnly)
                                            {
                                                @if ((column.DataType == "Choice" || column.DataType == "select") && !string.IsNullOrEmpty(column.SelectOptions))
                                                {
                                                    <select class="form-select form-select-sm cell-input"
                                                            value="@cellValue"
                                                            @onchange="e => UpdateCell(row, column.ColumnKey, e.Value?.ToString())">
                                                        <option value="">Select...</option>
                                                        @foreach (var option in column.SelectOptions.Split(','))
                                                        {
                                                            <option value="@option.Trim()">@option.Trim()</option>
                                                        }
                                                    </select>
                                                }
                                                else if (column.DataType is "Number" or "Currency" or "number" or "currency")
                                                {
                                                    <input type="number" class="form-control form-control-sm cell-input text-end"
                                                           value="@cellValue" step="0.01"
                                                           @onchange="e => UpdateCell(row, column.ColumnKey, e.Value?.ToString())" />
                                                }
                                                else if (column.DataType is "Checkbox" or "checkbox")
                                                {
                                                    <input type="checkbox" class="form-check-input"
                                                           checked="@(cellValue?.ToString()?.ToLower() == "true")"
                                                           @onchange="e => UpdateCell(row, column.ColumnKey, e.Value?.ToString())" />
                                                }
                                                else
                                                {
                                                    <input type="text" class="form-control form-control-sm cell-input"
                                                           value="@cellValue"
                                                           @onchange="e => UpdateCell(row, column.ColumnKey, e.Value?.ToString())" />
                                                }
                                            }
                                            else
                                            {
                                                <span class="@(column.DataType is "Number" or "Currency" or "Computed" or "number" or "currency" or "computed" ? "text-end d-block" : "")">
                                                    @FormatCellValue(cellValue, column.DataType, column.DecimalPlaces)
                                                </span>
                                            }
                                        </td>
                                    }
                                    @if (isDraft)
                                    {
                                        <td class="text-center">
                                            @if (isUnmatched)
                                            {
                                                <button class="btn btn-outline-primary btn-sm me-1" @onclick="() => ShowCataloguePicker(row)" title="Match to Catalogue">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            }
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteRow(row.Id)" title="Delete Row">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    }
                                </tr>
                            }
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr class="fw-bold">
                            @if (isDraft)
                            {
                                <td></td>
                            }
                            <td class="text-end">Totals:</td>
                            @foreach (var column in visibleColumns)
                            {
                                <td class="@(column.DataType is "number" or "currency" or "computed" ? "text-end" : "")">
                                    @if (column.DataType is "number" or "currency" or "computed")
                                    {
                                        @FormatCellValue(columnTotals.GetValueOrDefault(column.ColumnKey, 0m), column.DataType, column.Precision)
                                    }
                                </td>
                            }
                            @if (isDraft)
                            {
                                <td></td>
                            }
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Totals Summary -->
        <div class="row mt-4">
            <div class="col-md-6 offset-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calculator me-2"></i>Worksheet Summary
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-6">Material Cost</dt>
                            <dd class="col-sm-6 text-end">@worksheet.TotalMaterialCost.ToString("C")</dd>

                            <dt class="col-sm-6">Labor Hours</dt>
                            <dd class="col-sm-6 text-end">@worksheet.TotalLaborHours.ToString("N2")</dd>

                            <dt class="col-sm-6">Labor Cost</dt>
                            <dd class="col-sm-6 text-end">@worksheet.TotalLaborCost.ToString("C")</dd>

                            <dt class="col-sm-6 border-top pt-2"><strong>Total Cost</strong></dt>
                            <dd class="col-sm-6 text-end border-top pt-2">
                                <strong class="h5 text-success">@worksheet.TotalCost.ToString("C")</strong>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Column Manager Dialog -->
@if (showColumnManager)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-columns me-2"></i>Manage Columns</h5>
                    <button type="button" class="btn-close" @onclick="() => showColumnManager = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" @onclick="AddColumn">
                            <i class="fas fa-plus me-1"></i>Add Column
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Visible</th>
                                    <th>Name</th>
                                    <th>Key</th>
                                    <th>Type</th>
                                    <th>Source</th>
                                    <th>Formula</th>
                                    <th>Width</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var column in allColumns.OrderBy(c => c.DisplayOrder))
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input"
                                                   checked="@column.IsVisible"
                                                   @onchange="() => ToggleColumnVisibility(column)" />
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" @bind="column.DisplayName" style="width: 120px;" />
                                        </td>
                                        <td><code>@column.ColumnKey</code></td>
                                        <td>
                                            <select class="form-select form-select-sm" @bind="column.DataType" style="width: 100px;">
                                                <option value="Text">Text</option>
                                                <option value="Number">Number</option>
                                                <option value="Currency">Currency</option>
                                                <option value="Computed">Computed</option>
                                                <option value="Choice">Select</option>
                                                <option value="Date">Date</option>
                                                <option value="Checkbox">Checkbox</option>
                                                <option value="Catalogue">Catalogue</option>
                                            </select>
                                        </td>
                                        <td>
                                            @if (column.LinkToCatalogue)
                                            {
                                                <span class="badge bg-success"><i class="fas fa-book me-1"></i>@column.CatalogueField</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Custom</span>
                                            }
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" @bind="column.Formula"
                                                   placeholder="e.g., qty * unit_cost" style="width: 150px;"
                                                   disabled="@column.LinkToCatalogue" />
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" @bind="column.Width"
                                                   min="50" max="500" style="width: 80px;" />
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteColumn(column)" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showColumnManager = false">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveColumnChanges">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Catalogue Item Picker -->
<CatalogueItemPicker IsVisible="showCataloguePicker"
                     CompanyId="currentCompanyId"
                     MatchValue="@cataloguePickerMatchValue"
                     OnClose="CloseCataloguePicker"
                     OnItemSelected="OnCatalogueItemSelected" />

<style>
    .worksheet-editor-container {
        padding: 1rem;
    }

    .worksheet-grid-container {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
    }

    .worksheet-table-wrapper {
        max-height: calc(100vh - 400px);
        overflow: auto;
    }

    .worksheet-table {
        margin-bottom: 0;
    }

    .worksheet-table th,
    .worksheet-table td {
        white-space: nowrap;
        vertical-align: middle;
    }

    .worksheet-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .frozen-column {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: #f8f9fa;
    }

    .cell-input {
        border: none;
        background: transparent;
        width: 100%;
    }

    .cell-input:focus {
        background: #fff;
        border: 1px solid #86b7fe;
        outline: none;
    }

    .computed-cell {
        background-color: #e8f4f8;
    }

    .catalogue-cell {
        background-color: #e8f8e8;
    }

    .group-header-row {
        background-color: #e9ecef !important;
    }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 300px;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid #e9ecef;
        border-top-color: #0d6efd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

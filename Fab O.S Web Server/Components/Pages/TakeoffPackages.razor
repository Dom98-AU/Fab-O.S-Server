@page "/takeoffs/{TakeoffId:int}/packages"
@page "/takeoffs/{TakeoffId:int}/revisions/{RevisionId:int}/packages"
@rendermode InteractiveServer
@using FabOS.WebServer.Components.Shared
@using FabOS.WebServer.Components.Shared.Interfaces
@using FabOS.WebServer.Data.Contexts
@using FabOS.WebServer.Models.Entities
@using FabOS.WebServer.Models
@using Microsoft.EntityFrameworkCore

<PageTitle>Takeoff Packages - Fab.OS</PageTitle>

<!-- Standard Toolbar -->
<StandardToolbar ActionProvider="@this" OnSearch="@OnSearchChanged" SearchPlaceholder="Search packages..." PageType="PageType.List" />

<!-- Content -->
<div class="takeoff-packages-container">
    @if (isLoading)
    {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading packages...</p>
        </div>
    }
    else if (takeoff == null)
    {
        <div class="error-container">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Takeoff not found</h3>
            <p>The requested takeoff could not be found.</p>
            <button class="fabos-btn fabos-btn-primary" @onclick="NavigateToTakeoffs">
                <i class="fas fa-arrow-left"></i>
                Back to Takeoffs
            </button>
        </div>
    }
    else
    {
        <!-- Unified View Toolbar -->
        <TableViewToolbar TItem="Package"
                         EnableViewPreferences="true"
                         EnableColumnManagement="true"
                         EntityType="Package"
                         CurrentViewState="@currentViewState"
                         OnViewLoaded="@HandleViewLoaded"
                         HasUnsavedChanges="@hasUnsavedChanges"
                         Columns="@managedColumns"
                         OnColumnsChanged="@HandleColumnsChanged"
                         HasCustomColumnConfig="@hasCustomColumnConfig"
                         CurrentView="@currentView"
                         OnViewChanged="@OnViewChanged" />

        <!-- Views -->
        @if (filteredPackages.Any())
        {
            @if (currentView == FabOS.WebServer.Components.Shared.GenericViewSwitcher<FabOS.WebServer.Models.Entities.Package>.ViewType.Table)
            {
                <GenericTableView TItem="Package"
                                 Items="@filteredPackages"
                                 AllItems="@allPackages"
                                 Columns="@tableColumns"
                                 AllowSelection="true"
                                 ShowCheckboxes="true"
                                 SelectedItems="@selectedTableItems"
                                 SelectedItemsChanged="@HandleTableSelectionChanged"
                                 OnRowClick="@HandleRowClick"
                                 OnRowDoubleClick="@HandleRowDoubleClick"
                                 EnableAdvancedFeatures="true"
                                 EnableColumnManagement="true"
                                 EnableFiltering="true"
                                 EnableViewPreferences="true"
                                 EntityType="Package" />
            }
            else if (currentView == FabOS.WebServer.Components.Shared.GenericViewSwitcher<FabOS.WebServer.Models.Entities.Package>.ViewType.List)
            {
                <GenericListView TItem="Package"
                                Items="@filteredPackages"
                                OnItemClick="@HandleRowClick"
                                OnItemDoubleClick="@HandleRowDoubleClick"
                                AllowSelection="true"
                                SelectedItems="@selectedListItems"
                                SelectedItemsChanged="@HandleListSelectionChanged">
                    <CustomListItemContent Context="package">
                        <div class="package-list-item">
                            <div class="package-header">
                                <h3 class="package-title">@package.PackageName</h3>
                                <span class="package-number">@package.PackageNumber</span>
                            </div>
                            <p class="package-description">@(package.Description ?? "No description available")</p>
                            <div class="package-meta">
                                <span class="package-status">@(package.Status ?? "Active")</span>
                                <span class="package-hours">@package.EstimatedHours.ToString("N2") hours</span>
                                <span class="package-cost">$@package.EstimatedCost.ToString("N2")</span>
                            </div>
                        </div>
                    </CustomListItemContent>
                </GenericListView>
            }
            else if (currentView == FabOS.WebServer.Components.Shared.GenericViewSwitcher<FabOS.WebServer.Models.Entities.Package>.ViewType.Card)
            {
                <GenericCardView TItem="Package"
                                Items="@filteredPackages"
                                OnItemClick="@HandleRowClick"
                                OnItemDoubleClick="@HandleRowDoubleClick"
                                AllowSelection="true"
                                SelectedItems="@selectedCardItems"
                                SelectedItemsChanged="@HandleCardSelectionChanged">
                    <CustomCardContent Context="package">
                        <div class="package-card">
                            <div class="package-card-header">
                                <h4>@package.PackageName</h4>
                                <span class="badge">@package.PackageNumber</span>
                            </div>
                            <p class="package-card-description">@(package.Description ?? "No description")</p>
                            <div class="package-card-footer">
                                <span class="package-status">@(package.Status ?? "Active")</span>
                                <span class="package-cost">$@package.EstimatedCost.ToString("N2")</span>
                            </div>
                        </div>
                    </CustomCardContent>
                </GenericCardView>
            }
        }
        else
        {
            <div class="no-results">
                <i class="fas fa-box"></i>
                <h3>No Packages Found</h3>
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <p>Try adjusting your search criteria</p>
                }
            </div>
        }
    }
</div>

<style>
    .takeoff-packages-container {
        padding: 20px;
    }

    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .results-summary {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--fabos-text-secondary);
    }

    .error-container,
    .loading-container,
    .no-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
    }

    .error-container i,
    .no-results i {
        font-size: 48px;
        color: var(--fabos-text-secondary);
        margin-bottom: 20px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--fabos-border);
        border-top-color: var(--fabos-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .package-list-item,
    .package-card {
        padding: 15px;
    }

    .package-header,
    .package-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .package-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 500;
    }

    .package-number,
    .badge {
        background: var(--fabos-primary);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .package-description,
    .package-card-description {
        color: var(--fabos-text-secondary);
        margin: 10px 0;
    }

    .package-meta,
    .package-card-footer {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
    }

    .package-status {
        color: var(--fabos-success);
    }

    .package-hours,
    .package-cost {
        font-weight: 500;
    }
</style>
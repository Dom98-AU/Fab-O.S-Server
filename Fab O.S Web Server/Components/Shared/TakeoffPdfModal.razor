@namespace FabOS.WebServer.Components.Shared
@using FabOS.WebServer.Services.Interfaces
@inject IScaleCalibrationService ScaleCalibrationService
@inject NavigationManager Navigation

<ModalTemplate @bind-IsVisible="IsVisible"
               Title="@GetModalTitle()"
               ModalType="ModalTemplate.ModalDisplayType.Fullscreen"
               ShowCloseButton="true"
               CloseOnBackdrop="false"
               OnClose="HandleClose">
    <ChildContent>
        @if (IsVisible && PackageDrawingId > 0)
        {
            <div class="pdf-viewer-container-with-controls">
                <div class="viewer-toolbar">
                    <button class="btn btn-sm btn-warning" @onclick="OpenInFoxitViewer" title="Test with Foxit SDK POC">
                        <i class="fas fa-flask"></i>
                        Test with Foxit SDK
                    </button>
                </div>
                <NutrientPdfViewer PackageDrawingId="@PackageDrawingId"
                                  OnClose="HandleClose"
                                  @ref="nutrientViewer" />
            </div>
        }
    </ChildContent>
</ModalTemplate>

<style>
    .pdf-viewer-container-with-controls {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .viewer-toolbar {
        padding: 0.5rem;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
</style>

<!-- Scale Calibration Modal -->
<ModalTemplate @bind-IsVisible="showScaleCalibrationModal"
               Title="Scale Calibration"
               ModalType="ModalTemplate.ModalDisplayType.Standard"
               Size="ModalTemplate.ModalSize.Large"
               ShowCloseButton="true"
               CloseOnBackdrop="false"
               OnClose="CloseScaleCalibration">
    <ChildContent>
        <ScaleCalibrationComponent PackageDrawingId="@PackageDrawingId"
                                  OnCalibrationComplete="HandleCalibrationComplete"
                                  OnClose="CloseScaleCalibration" />
    </ChildContent>
</ModalTemplate>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public int PackageDrawingId { get; set; }
    [Parameter] public string Title { get; set; } = "PDF Takeoff";
    [Parameter] public EventCallback OnClose { get; set; }

    private bool showScaleCalibrationModal = false;
    private NutrientPdfViewer? nutrientViewer;

    protected override async Task OnParametersSetAsync()
    {
        // Update title based on drawing info if needed
        if (PackageDrawingId > 0 && string.IsNullOrEmpty(Title))
        {
            Title = "PDF Takeoff";
        }
    }

    private async Task HandleClose()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        await OnClose.InvokeAsync();
    }

    private void OpenScaleCalibration()
    {
        showScaleCalibrationModal = true;
    }

    private void CloseScaleCalibration()
    {
        showScaleCalibrationModal = false;
    }

    private void HandleCalibrationComplete()
    {
        showScaleCalibrationModal = false;
        // TODO: Update scale in Nutrient viewer if needed
    }

    public void RefreshData()
    {
        // TODO: Implement refresh for Nutrient viewer if needed
    }

    private string GetModalTitle()
    {
        return $"{Title} (Nutrient)";
    }

    private void OpenInFoxitViewer()
    {
        // Navigate to Foxit viewer with same drawing
        Navigation.NavigateTo($"/takeoff/foxit/{PackageDrawingId}", forceLoad: true);
    }
}
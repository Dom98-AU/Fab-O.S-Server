@inherits LayoutComponentBase
@using FabOS.WebServer.Components.Layout
@using FabOS.WebServer.Components.Sidebar
@using FabOS.WebServer.Components.Shared
@using FabOS.WebServer.Services
@using System.Linq
@inject BreadcrumbNavigationService BreadcrumbNav
@implements IDisposable

<div class="fabos-app">
    <!-- NEW Modular Sidebar Component (White Theme with Lucide Icons) -->
    <FabOSSidebar />

    <!-- OLD Monolithic Sidebar (Dark Theme) - Commented out for comparison -->
    @* <InteractiveSidebar /> *@

    <!-- Main Content Area -->
    <div class="fabos-main-content">
        <!-- Top Bar -->
        <div class="fabos-top-bar">
            <!-- Breadcrumb Navigation (Automatic - based on URL) -->
            @if (breadcrumbs.Any())
            {
                <Breadcrumb Items="@breadcrumbs" />
            }

            <div class="fabos-user-section">
                <div class="fabos-user-info">
                    <span class="fabos-user-name">Admin User</span>
                    <span class="fabos-user-email">admin@steelestimation.com</span>
                </div>
                <button class="fabos-user-menu-button">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Page Content -->
        <div class="fabos-page-content">
            @Body
        </div>
    </div>
</div>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">üóô</a>
</div>

@code {
    private List<Breadcrumb.BreadcrumbItem> breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to breadcrumb changes
        BreadcrumbNav.OnBreadcrumbsChanged += OnBreadcrumbsChanged;

        // Load initial breadcrumbs
        await UpdateBreadcrumbsAsync();
    }

    private void OnBreadcrumbsChanged()
    {
        _ = UpdateBreadcrumbsAsync();
    }

    private async Task UpdateBreadcrumbsAsync()
    {
        breadcrumbs = await BreadcrumbNav.GetBreadcrumbsAsync();
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        BreadcrumbNav.OnBreadcrumbsChanged -= OnBreadcrumbsChanged;
    }
}

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("PDFViewCtrl"),require("PDFViewCtrl").commons):"function"==typeof define&&define.amd?define(["PDFViewCtrl",["PDFViewCtrl","commons"]],t):"object"==typeof exports?exports.PDFViewCtrl_EditGraphicsAddonModule=t(require("PDFViewCtrl"),require("PDFViewCtrl").commons):e.PDFViewCtrl_EditGraphicsAddonModule=t(e.PDFViewCtrl,e.PDFViewCtrl.commons)}(self,(e,t)=>(()=>{"use strict";var n={778:t=>{t.exports=e},457:e=>{e.exports=t}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var o=r[e]={exports:{}};return n[e](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{function e(t,n){return null!=n&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?!!n[Symbol.hasInstance](t):e(t,n)}function t(t,n){if(!e(t,n))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}i.r(o),i.d(o,{EditGraphicsAddon:()=>vt,EditGraphicsAddonEvents:()=>b});var a=i(778);function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function s(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(s=function(){return!!e})()}function u(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function h(e,t,n){return t=c(t),u(e,s()?Reflect.construct(t,n||[],c(e).constructor):t.apply(e,n))}function l(e,t,n){return l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}},l(e,t,n||e)}function d(e,t){return d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},d(e,t)}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}const p={print:4,modify:8,extract:16,annotForm:32,fillForm:256,extractAccess:512,assemble:1024,printHigh:2048};var v=a.Deps.jQuery,E=a.shared.browser.getPtPxRatio,g=a.Events,_=(a.shared.activation.ActivationGroup,a.commons.notImplemented),m=(a.PDF.engine.GraphicsObject,a.keyboard),T=m.BuiltinShortcutContext,A=m.BuiltinCommand,y=function(n){function i(e,n,r){var o;return t(this,i),(o=h(this,i)).isDestroyed=!1,o.graphicsObject=e,o.pageRender=n,o.dependences=r,o}return f(i,n),r(i,[{key:"doActive",value:function(){var e=this.$handler,t=this.dependences.pdfViewer;if(!e){e=this.initUI(),this.$handler=e;var n=this.getContextMenuConfig();n&&!this.contextmenu&&(this.contextmenu=t.viewerUI.createContextMenu(this,e.get(0),n))}e.addClass("fwr__active"),this.updateShapeControl(),this.bindEvent()}},{key:"getContextMenuConfig",value:function(){}},{key:"getContextMenuComponentName",value:function(){_()}},{key:"removeGraphicObject",value:function(){this.remove()}},{key:"remove",value:function(){var e=this;if(this.isActive){this.removeToolbar&&this.removeToolbar();var t=this.dependences.pdfViewer;t.getAllActiveElements().forEach(function(t){t.unActive(),t!==e&&t.remove&&t.remove()}),0===t.getAllActiveElements().length&&t.activeElement()}}},{key:"removeGraphicObjects",value:function(e){for(var t=e.length-1;t>=0;t--){var n=e[t];if(n.removeToolbar&&n.removeToolbar(),n.unActive(),n.dependences.pdfViewer.unActiveElement(n),n.destroy(),!n.graphicsObject.doc.checkPermission(p.modify))throw new Error("Permission error");var r=0===t;n.graphicsObject.getPDFPage().removeGraphicsObjectEx(n.graphicsObject,r)}this.dependences.pdfViewer.activeElement()}},{key:"bindEvent",value:function(){var e=this,t=this.dependences.pdfViewer;t.getKeyboard().withContext(T.ACTIVATION_ANY,function(n){e.isDestroyed||(e.__off__delete__event__=n.keydown(A.DELETE_SELECTED_OBJECT,function(n){var r=t.getAllActiveElements();r.length>1?e===r[r.length-1]&&e.removeGraphicObjects(r):e.removeGraphicObject(),e.__off__delete__event__()}),e.__off__esc__event__=n.keydown(A.UNSELECT_OBJECT,function(t){e.unActive(!0)}))})}},{key:"unBindEvent",value:function(){this.__off__delete__event__&&this.__off__delete__event__(),this.__off__delete__event__=function(){},this.__off__esc__event__&&this.__off__esc__event__(),this.__off__esc__event__=function(){},this.__off_active_escape_event&&this.__off_active_escape_event(),delete this.__off_active_escape_event}},{key:"translateContextMenuName",value:function(e){for(var t in e)if("items"===t){var n=e[t],r=this.dependences.pdfViewer.i18n;for(var i in n){var o=n[i];o.nameI18nKey&&(o.name=r.t(o.nameI18nKey))}}return e}},{key:"updateShapeControl",value:function(){var e=this.getBoundary(),t=this._getShapeControllerBoundaryBox();this.shapeControl&&this.shapeControl.active(this.$handler,e,t)}},{key:"unActive",value:function(){this.isActive&&(l(c(i.prototype),"unActive",this).call(this),this.$handler&&(this.$handler.removeClass("fwr__active"),this.shapeControl&&this.shapeControl.deactive(),this.dependences.pdfViewer.eventEmitter.off(g.fitWidthResizeViewport,this.afterZoom),this.dependences.pdfViewer.eventEmitter.off(g.zoomToSuccess,this.afterZoom),this.$handler&&this.$handler.remove(),this.$handler=null,this.unBindEvent(),this.$charEditContainer&&this.$charEditContainer.off("focus"),this.removeToolbar&&this.removeToolbar()))}},{key:"doDeactive",value:function(){}},{key:"destroy",value:function(){this.isDestroyed=!0,this.unActive(),this.shapeControl&&this.shapeControl.destroy(),this.contextmenu&&this.contextmenu.destroy()}},{key:"getModel",value:function(){return this.graphicsObject}},{key:"_getShapeControllerBoundaryBox",value:function(){var e,t=this.pageRender.page,n=E()*this.pageRender.getScale(),r=[t.getPxWidth()*n,t.getPxHeight()*n],i=r[0],o=r[1];this.pageRender.rotate%180!=0&&(o=(e=[i,o])[0],i=e[1]);return{left:0,top:0,width:i,height:o}}},{key:"getBoundary",value:function(){var e=this.pageRender.page,t=this.graphicsObject.getRect(),n=e.getDeviceRect(t,this.pageRender.getScale(),this.pageRender.getRotation());return{left:n.left,top:n.top,width:n.right-n.left,height:n.bottom-n.top}}},{key:"initUI",value:function(){var e=this;if(!this.$handler){var t=this.$handler=v('<div class="fwr__graphics-object-handler"\n        ></div>');this.pageRender.pageHandler.$handler.append(t),t.get(0).__graphics_object_component=this;var n=!0;return this.predefineTextObject&&(n=!1),this.shapeControl=new a.ShapeControl({prestart:function(){return e.onPrestart()},start:function(t,n,r){return e.onStartUpdateShape(t,n,r)},moving:function(t,n,r){var i=r.offsetX,o=r.offsetY;return e.onShapeMoving(t,n,i,o)},update:function(t,n){return e.onShapeUpdating(t,n)},end:function(t,n,r,i){return e.onShapeUpdateEnd(t,n,r,i)},afterEnd:function(t){return e.onAfterShapeCtrlEnd(t)},resizable:n,enableDiagonally:!0,enableFrame:!0,previewer:!0,auxiliaryLine:void 0}),this.dependences.pdfViewer.eventEmitter.on(g.zoomToSuccess,this.afterZoom=function(){e.updateShapeControl()}),this.dependences.pdfViewer.eventEmitter.on(g.fitWidthResizeViewport,this.afterZoom),this.$handler}}},{key:"onPrestart",value:function(){var t=this;this.dependences.pdfViewer.getAllActiveElements().forEach(function(n){n!==t&&e(n,i)&&t.shapeControl.companion(n.shapeControl)})}},{key:"onAfterShapeCtrlEnd",value:function(e){this.shapeControl.clearCompanions()}},{key:"onStartUpdateShape",value:function(e,t,n){var r=this;if("move"){if(this.dependences.pdfViewer.getAllActiveElements().length>1||!this.graphicsObject.getBitmap)return;v(this.shapeControl.ui.querySelector(".fv__shape-control-previewer")).show(),this.graphicsObject.getBitmap(this.pageRender.getScale(),this.pageRender.getRotation()).then(function(e){if(e){var t=r.shapeControl.getPreviewerContext();v(t.canvas).attr({width:e.width,height:e.height});var n=t.createImageData(e.width,e.height+1),i=new(Uint8ClampedArray||Uint8Array)(e.buffer);n.data.set(i),t.putImageData(n,0,0)}})}}},{key:"onShapeMoving",value:function(e,t){}},{key:"onShapeUpdating",value:function(e,t){}},{key:"onShapeUpdateEnd",value:function(e,t,n){var r=this,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=Object.assign({},e);o.right=o.left+o.width,o.bottom=o.top+o.height,o=this.pageRender.page.reverseDeviceRect(o,this.pageRender.getScale(),this.pageRender.getRotation()),this.graphicsObject.setRect(o,i).then(function(e){v(r.shapeControl.ui.querySelector(".fv__shape-control-previewer")).hide(),r.updateShapeControl()})}},{key:"setColor",value:function(e){return this.graphicsObject.setBorderColor(e)}},{key:"setBorderStyle",value:function(e,t){var n=this;return this.graphicsObject.setBorderStyle(e,t).then(function(e){n.updateShapeControl()})}},{key:"setOpacity",value:function(e){return this.graphicsObject.setOpacity(e)}},{key:"setFillColor",value:function(e){return this.graphicsObject.setFillColor(e)}},{key:"setBorderWidth",value:function(e){var t=this;return this.graphicsObject.setBorderWidth(e).then(function(e){t.updateShapeControl()})}},{key:"moveToPosition",value:function(e,t){var n=this;return this.graphicsObject.moveToPosition(e,t).then(function(e){n.updateShapeControl()})}},{key:"getGraphicsObject",value:function(){return this.graphicsObject}}]),i}(a.shared.activation.Activatable);function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function R(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function S(e,t){if(e){if("string"==typeof e)return R(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?R(e,t):void 0}}function w(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o=[],a=!0,c=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){c=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(c)throw i}}return o}}(e,t)||S(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}const b={textObjectActive:"text-object-active",textObjectUnActive:"text-object-unactive",addTextObjectParamTransfer:"add-text-object-param-transfer"};var x,H={};"function"==typeof FontFace?x=function(e,t){return H[e]?H[e]:H[e]=new Promise(function(n,r){t().then(function(t){if(!t)return r(),void H[e];var i=new FontFace(e,t.buffer||t.url);i.load().then(function(){document.fonts.add(i),n(i)},function(){r(),delete H[e]})},function(){r(),delete H[e]})})}:x=function(e,t){return H[e]?H[e]:H[e]=new Promise(function(n,r){t().then(function(t){return t?t.buffer?URL.createObjectURL(new Blob([t.buffer],"application/x-font-woff")):t.url:(r("woff is invalid"),void delete H[e])}).then(function(t){if(!t)return r();var i=document.createElement("style");i.innerHTML='@font-face{font-family:"'+e+'"; src:url("'+t+'");}',document.head.appendChild(i),n(i)})})};var D,L=function(e){return e.STATE_HANDLER_HAND="hand",e.STATE_HANDLER_CHECK_THE_SEARCH="checkTheSearch",e.STATE_HANDLER_CREATE_CARET="createCaret",e.STATE_HANDLER_CREATE_ARROW="createArrow",e.STATE_HANDLER_CREATE_AREA_HIGHLIGHT="createAreaHighlight",e.STATE_HANDLER_CREATE_CREATE_AREA_HIGHLIGHT="createAreaHighlight",e.STATE_HANDLER_CREATE_CIRCLE="createCircle",e.STATE_HANDLER_CREATE_FILE_ATTACHMENT="createFileAttachment",e.STATE_HANDLER_CREATE_HIGHLIGHT="createHighlight",e.STATE_HANDLER_CREATE_IMAGE="createImage",e.STATE_HANDLER_CREATE_LINK="createLink",e.STATE_HANDLER_CREATE_LINE="createLine",e.STATE_HANDLER_CREATE_DISTANCE="createDistance",e.STATE_HANDLER_CREATE_PERIMETER="createPerimeter",e.STATE_HANDLER_CREATE_AREA="createArea",e.STATE_HANDLER_CREATE_CIRCLE_AREA="createCircleArea",e.STATE_HANDLER_CREATE_PENCIL="createPencil",e.STATE_HANDLER_CREATE_POLYGON_CLOUD="createPolygonCloud",e.STATE_HANDLER_CREATE_POLYGON="createPolygon",e.STATE_HANDLER_CREATE_POLYLINE="createPolyline",e.STATE_HANDLER_CREATE_REPLACE="createReplace",e.STATE_HANDLER_CREATE_SQUARE="createSquare",e.STATE_HANDLER_CREATE_SQUIGGLY="createSquiggly",e.STATE_HANDLER_CREATE_STAMP="createStamp",e.STATE_HANDLER_CREATE_STRIKE_OUT="createStrikeOut",e.STATE_HANDLER_CREATE_TEXT="createText",e.STATE_HANDLER_CREATE_UNDERLINE="createUnderline",e.STATE_HANDLER_MARQUEE="marquee",e.STATE_HANDLER_ERASER="eraser",e.STATE_HANDLER_LOUPE="loupe",e.STATE_HANDLER_SELECT_TEXT_ANNOTATION="select-text-annotation",e.STATE_HANDLER_SELECT_TEXT_IMAGE="select-text-image",e.STATE_HANDLER_SELECT_ANNOTATION="select-annotation",e.STATE_HANDLER_CREATE_FREETEXT_BOX="createFreeTextBox",e.STATE_HANDLER_CREATE_FREETEXT_CALLOUT="createFreeTextCallout",e.STATE_HANDLER_CREATE_FREETEXT_TYPEWRITER="createFreeTextTypewriter",e.STATE_HANDLER_CREATE_FIELD_TEXT="CreateTextStateHandler",e.STATE_HANDLER_CREATE_FIELD_SIGNATURE="CreateSignStateHandler",e.STATE_HANDLER_CREATE_FIELD_PUSH_BUTTON="CreatePushButtonStateHandler",e.STATE_HANDLER_CREATE_FIELD_CHECK_BOX="CreateCheckBoxStateHandler",e.STATE_HANDLER_CREATE_RADIO_BUTTON="CreateRadioButtonStateHandler",e.STATE_HANDLER_CREATE_FIELD_COMBO_BOX="CreateComboBoxStateHandler",e.STATE_HANDLER_CREATE_FIELD_LIST_BOX="CreateListBoxStateHandler",e.STATE_HANDLER_CREATE_FIELD_DATE="CreateDateStateHandler",e.STATE_HANDLER_CREATE_FIELD_IMAGE="CreateImageStateHandler",e.STATE_HANDLER_SNAPSHOT_TOOL="snapshot-tool",e.STATE_HANDLER_CREATE_DOCUMENT_ATTACHMENT="createDocumentAttachment",e}({}),P=L.STATE_HANDLER_HAND,O=(L.STATE_HANDLER_CHECK_THE_SEARCH,L.STATE_HANDLER_CREATE_CARET),N=L.STATE_HANDLER_CREATE_ARROW,k=L.STATE_HANDLER_CREATE_AREA_HIGHLIGHT,I=(L.STATE_HANDLER_CREATE_AREA_HIGHLIGHT,L.STATE_HANDLER_CREATE_CIRCLE),j=L.STATE_HANDLER_CREATE_FILE_ATTACHMENT,B=L.STATE_HANDLER_CREATE_HIGHLIGHT,V=L.STATE_HANDLER_CREATE_IMAGE,M=L.STATE_HANDLER_CREATE_LINK,F=L.STATE_HANDLER_CREATE_LINE,G=L.STATE_HANDLER_CREATE_DISTANCE,U=L.STATE_HANDLER_CREATE_PERIMETER,$=L.STATE_HANDLER_CREATE_AREA,X=L.STATE_HANDLER_CREATE_CIRCLE_AREA,Y=L.STATE_HANDLER_CREATE_PENCIL,K=L.STATE_HANDLER_CREATE_POLYGON_CLOUD,W=L.STATE_HANDLER_CREATE_POLYGON,z=L.STATE_HANDLER_CREATE_POLYLINE,q=L.STATE_HANDLER_CREATE_REPLACE,Q=L.STATE_HANDLER_CREATE_SQUARE,J=L.STATE_HANDLER_CREATE_SQUIGGLY,Z=L.STATE_HANDLER_CREATE_STAMP,ee=L.STATE_HANDLER_CREATE_STRIKE_OUT,te=L.STATE_HANDLER_CREATE_TEXT,ne=L.STATE_HANDLER_CREATE_UNDERLINE,re=(L.STATE_HANDLER_MARQUEE,L.STATE_HANDLER_ERASER,L.STATE_HANDLER_LOUPE,L.STATE_HANDLER_SELECT_TEXT_ANNOTATION,L.STATE_HANDLER_SELECT_TEXT_IMAGE,L.STATE_HANDLER_SELECT_ANNOTATION,L.STATE_HANDLER_CREATE_FREETEXT_TYPEWRITER),ie=L.STATE_HANDLER_CREATE_FREETEXT_CALLOUT,oe=L.STATE_HANDLER_CREATE_FREETEXT_BOX,ae=(L.STATE_HANDLER_SNAPSHOT_TOOL,L.STATE_HANDLER_CREATE_DOCUMENT_ATTACHMENT,L.STATE_HANDLER_CREATE_FIELD_TEXT,L.STATE_HANDLER_CREATE_FIELD_SIGNATURE,L.STATE_HANDLER_CREATE_FIELD_PUSH_BUTTON,L.STATE_HANDLER_CREATE_FIELD_CHECK_BOX,L.STATE_HANDLER_CREATE_RADIO_BUTTON,L.STATE_HANDLER_CREATE_FIELD_COMBO_BOX,L.STATE_HANDLER_CREATE_FIELD_LIST_BOX,L.STATE_HANDLER_CREATE_FIELD_DATE,L.STATE_HANDLER_CREATE_FIELD_IMAGE,L.STATE_HANDLER_CREATE_RADIO_BUTTON,C(D={},te,"text"),C(D,B,"highlight"),C(D,ee,"strikeout"),C(D,ne,"underline"),C(D,J,"squiggly"),C(D,q,"strikeout"),C(D,O,"caret"),C(D,re,"freetext"),C(D,ie,"freetext"),C(D,oe,"freetext"),C(D,Q,"square"),C(D,I,"circle"),C(D,F,"line"),C(D,N,"line"),C(D,W,"polygon"),C(D,z,"polyline"),C(D,K,"polygon"),C(D,k,"highlight"),C(D,Y,"ink"),C(D,Z,"stamp"),C(D,G,"line"),C(D,U,"polyline"),C(D,$,"polygon"),C(D,X,"circle"),C(D,j,"fileattachment"),C(D,V,"screen"),C(D,M,"link"),C(D,"create-multi-media-state","screen"),C(D,"create-redaction-text-image-state","redact"),C(D,"create-redaction-state","redact"),i(457)),ce=a.Deps.jQuery,se=a.shared.browser.getPtPxRatio,ue=a.ViewerEvents.renderPageSuccess,he=a.ViewerEvents.switchStateHandler,le=a.keyboard,de=le.BuiltinCommand,fe=le.BuiltinShortcutContext,pe=a.shared.debounce,ve=a.commons,Ee=ve.colorConvertor,ge=(ve.KeyCodes,ve.KeyboardUtils),_e=(ge.isMatch,ge.matchers,function(e){function n(e,r,i){var o;return t(this,n),(o=h(this,n,[e,r,i])).fillSign=!1,o}return f(n,e),r(n,[{key:"initUI",value:function(){var e=this,t=this.$handler=ce('<div class="fwr__graphics-object-handler fwr__text-object-edit"\n        ></div>');this.pageRender.pageHandler.$handler.after(t),t.get(0).__graphics_object_component=this;this.shapeControl=new a.ShapeControl({prestart:function(){return e.onPrestart()},start:function(t,n,r){return e.onStartUpdateShape(t,n,r)},moving:function(t,n,r){var i=r.offsetX,o=r.offsetY;return e.onShapeMoving(t,n,i,o)},update:function(t,n){return e.onShapeUpdating(t,n)},rotate:function(t,n){return e.onRotate(t,n)},end:function(t,n,r,i){return e.onShapeUpdateEnd(t,n,r,i)},afterEnd:function(t){return e.onAfterShapeCtrlEnd(t)},resizable:!0,enableDiagonally:!0,enableFrame:!0,previewer:!0});return t.on("dblclick",function(){e.unActive(),e.activeCharEdit()}),this.$handler}},{key:"reActive",value:function(){}},{key:"active",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];l(c(n.prototype),"active",this).call(this),this.reActive=function(){e.unActive(),e.active()};var r=this.pageRender.pdfViewer.getEventEmitter();t&&r.emit(b.textObjectActive,this),this.pageRedrawBind&&r.off(ue,this.pageRedrawBind),r.on(ue,this.pageRedrawBind=function(t){t.index===e.getModel().getPDFPage().getIndex()&&e.reActive()}),r.on(he,this.switchStateHandlerBind=function(){e.eCharInput&&e.applyEdit()})}},{key:"unActive",value:function(){this.dependences.pdfViewer._setSaveBefore(),l(c(n.prototype),"unActive",this).call(this),this.unActiveCharEdit();var e=this.pageRender.pdfViewer.getEventEmitter();e.off(ue,this.pageRedrawBind),e.off(he,this.switchStateHandlerBind),e.emit(b.textObjectUnActive,this)}},{key:"unActiveCharEdit",value:function(){this.$charEditContainer&&this.$charEditContainer.remove(),this.$charEditContainer=null,this.unswitchBinder&&this.unswitchBinder()}},{key:"applyEdit",value:function(){var e=this;if(!this.eCharInput)return Promise.reject(new Error("text input box has not been initialized!"));var t=this.eCharInput.innerText;"string"!=typeof t&&(t=this.eCharInput.textContent);for(var n="",r=0,i=0;i<t.length;i++){this.eCharInput.innerText=t.substring(0,i+1);for(var o=t[i];("\n"==o||"\r"==o)&&i<t.length;)o=t[++i];var a=this.eCharInput.offsetHeight;void 0!==o&&(n+=0!==r&&r<a?"\n"+o:o),r=a}return t=n.replace(/\u00a0/g," "),this.isApplyEdit=!0,this.setTextChar(t).then(function(){e.unActive()}).finally(function(){e.isApplyEdit=!1})}},{key:"initCharEditContainer",value:function(){var e,t=this;e=this.fillSign?ce('<div class="fv__text-object-edit-char-container"><div class="fv__text-object-edit-char-mask-layer"></div><div><span class="fv_fillsign-moving"></span><span class="fv__text-object-edit-char-input fv_fillsign-input" contenteditable></span></div></div>'):ce('<div class="fv__text-object-edit-char-container"><div class="fv__text-object-edit-char-mask-layer"></div><span class="fv__text-object-edit-char-input " contenteditable></span></div>'),this.pageRender.$handler.after(e);var n=e.find(".fv__text-object-edit-char-input"),r=n[0];return this.eCharInput=r,n.on("keydown",function(r){if(!r.shiftKey&&(13===r.keyCode&&(r.preventDefault(),t.applyEdit()),t.fillSign)){var i=e.find(".fv__text-object-edit-char-mask-layer"),o=n[0].getBoundingClientRect().width;i.width()<o+15&&i.css("width",o+15+"px")}}),this.fillSign&&this.bindMovingEvent(e),e}},{key:"activeCharEdit",value:function(e){var t=this;this.isActive=!0;var n=this.$charEditContainer=this.$charEditContainer||this.initCharEditContainer(),r=n.find(".fv__text-object-edit-char-mask-layer"),i=n.find(".fv__text-object-edit-char-input");this.dependences.pdfViewer._setSaveBefore(function(){return t.applyEdit()});var o=this.graphicsObject,c=o.getRect(),s=this.pageRender,u=s.pdfViewer;return i.off("focus").on("focus",function(){var e,n=u.getKeyboard(),r=n.activeContext(fe.EDIT_TEXT_OBJECT),i=!1;n.withContext(fe.EDIT_TEXT_OBJECT,function(n){i||(e=n.keyup(de.BLUR_EDITTING_TEXT_OBJECT,function(){var e=t.eCharInput.innerText;"string"!=typeof e&&(e=t.eCharInput.textContent),t.setTextChar(e).then(function(){t.unActive()}),u.getStateHandlerManager().switchTo(P)}))}),t.unswitchBinder=function(){i||(i=!0,r(),e&&e())}}),u.getEventEmitter().on(he,this.switchStateHandlerBind=function(){t.eCharInput&&t.applyEdit()}),Promise.all([s.getPDFPage(),s.getScale(),s.getRotation()]).then(function(e){var t=w(e,3),n=t[0],r=t[1],i=t[2];return[n.getDeviceRect(c,r,i),n,r,i]}).then(function(i){var c=w(i,4),u=c[0],h=c[1],l=c[2],d=c[3],f=function(){var e=s.$ui[0].getBoundingClientRect(),t=v.getBoundingClientRect();return{maxWidth:e.right-t.left,maxHeight:e.bottom-t.top}};n.css({left:u.left+"px",top:u.bottom+"px"});var p=n.find(".fv__text-object-edit-char-input"),v=p[0];r.css({width:u.right-u.left+"px",height:u.bottom-u.top+"px"});var E=o.getText();E=E.replace(/\u0020/g,"Â "),void 0===e&&(e=E),"string"==typeof v.innerText?v.innerText=E:v.textContent=E;var g=o.getFontSize(),_=o.getMatrix().toArray().slice(0,4),m=12,T=g*se()<m;T&&(g*=m,_[0]/=m,_[1]/=m,_[2]/=m,_[3]/=m),_[0]*=l,_[1]*=-l,_[2]*=-l,_[3]*=l;var A=new a.Matrix(_[0],_[1],_[2],_[3],0,0),y=h.getRotationAngle()+d;if(A.rotate(y/180*Math.PI),t.fillSign)p.css(C({fontSize:g+"pt",transform:"matrix("+A.toArray().join(",")+")",color:Ee(16777215&o.getFillColor(),"#")},"transform","matrix("+A.toArray().join(",")+")"));else{if("TimesNewRoman"===o.info.textState.font.baseName)otherFontName="Times New Roman";p.css({fontFamily:'"'+[o.info.textState.font.baseName,o.info.textState.font.familyName,o.info.textState.font.nameKey,o.info.textState.font.name,"FoxitPDFSDKForWeb"].join('","')+'"',fontSize:g+"pt",fontWeight:o.info.textState.font.isBold?700:400,fontStyle:o.info.textState.font.isItalic?"italic":"",transform:"matrix("+A.toArray().join(",")+")",color:Ee(16777215&o.getFillColor(),"#")})}var R,S,H=p.height(),D=p.width(),L=A.transformPoint(D,H),P=L[0],O=L[1];t.fillSign&&t.showToolbar(Math.abs(O)),P>=0&&O>0?(R=-A.transformPoint(D,0)[1]-H,S=0):P<0&&O>=0?(R=-A.transformPoint(D,0)[1]-H,S=-A.transformPoint(0,D)[1]):P<=0&&O<0?(R=A.transformPoint(0,H)[1]-H,S=-P+A.transformPoint(0,H)[0]):P>0&&O<=0&&(R=-A.transformPoint(0,H)[1]-H,S=P-A.transformPoint(D,0)[0]),p.css({top:R+"px",left:S+"px",transformOrigin:"left "+H+"px",bottom:"auto"}),e!==E&&("string"==typeof v.innerText?v.innerText=e:v.textContent=e),t.fillSign||x(o.info.textState.font.nameKey||o.info.textState.font.name,o.getWoff.bind(o)).catch(function(){}),t.reActive=function(e){t.unActive(),t.activeCharEdit(e)};var N=t.pageRender.pdfViewer.getEventEmitter();t.fillSign||N.emit(b.textObjectActive,t),document.activeElement!==v&&v.focus();var k=f(),I=k.maxWidth,j=k.maxHeight,B=T?l/m:l;v.style.cssText+="\n                max-width: ".concat(I/B,"px;\n            ");var V=v.textContent,M=function(){v.style.cssText+="\n                    white-space: pre;\n                    width: auto;\n                ";var e=v.getBoundingClientRect().width;v.style.cssText+="\n                    width: ".concat(Math.min(I,e)/B,"px;\n                    white-space: pre-line;\n                ");var t=(0,ae.getCursorPositionOfEditableElement)(v);v.getBoundingClientRect().height>j?(v.textContent=V,(0,ae.moveCursorTo)(v,t)):V=v.textContent},F=!1;v.addEventListener("input",function(){F||M()}),v.addEventListener("compositionstart",function(){F=!0,v.style.maxWidth=I/l+"px"});var G=pe(M,0);v.addEventListener("compositionupdate",function(){G()}),v.addEventListener("compositionend",function(){F=!1,v.style.maxWidth="",M()}),t.pageRedrawBind&&N.off(ue,t.pageRedrawBind),N.on(ue,t.pageRedrawBind=function(n){if(n.index===t.getModel().getPDFPage().getIndex()){e="string"==typeof v.innerText?v.innerText:v.textContent;var r=f(),i=r.maxWidth,o=r.maxHeight;I=i,j=o;var a=T?n.scale/m:n.scale;v.style.cssText+="\n                        max-width: ".concat(I/a,"px;\n                    ")}})})}},{key:"showToolbar",value:function(e){}},{key:"setTextChar",value:function(e){return this.graphicsObject.setText(e)}},{key:"getContextMenuConfig",value:function(){}},{key:"getTextChar",value:function(){if(this.$charEditContainer){var e=this.$charEditContainer.find(".fv__text-object-edit-char-input")[0],t=e.innerText;return"string"!=typeof t&&(t=e.textContent),t.replace(/\u00a0/g," ")}return this.getModel().getText()}},{key:"textCharSure",value:function(){return!this.isApplyEdit&&this.$charEditContainer?this.fillSign?this.saveFillSign():this.applyEdit():Promise.resolve()}},{key:"remove",value:function(){return l(c(n.prototype),"remove",this).call(this),this.dependences.pdfViewer.unActiveElement(this),this.destroy(),this.graphicsObject.remove()}}]),n}(y));function me(e){if("clientX"in e)return e.clientX;switch(e.type){case"touchstart":case"touchmove":return e.touches[0].clientX;case"touchend":case"touchcancel":return e.changedTouches[0].clientX}}function Te(e){if("clientY"in e)return e.clientY;switch(e.type){case"touchstart":case"touchmove":return e.touches[0].clientY;case"touchend":case"touchcancel":return e.changedTouches[0].clientY}}var Ae=a.Deps.jQuery,ye=a.commons.colorConvertor,Ce=function(e){function n(e,r,i){return t(this,n),h(this,n,[e,r,i])}return f(n,e),r(n,[{key:"active",value:function(){l(c(n.prototype),"active",this).call(this)}},{key:"getPropertyOptions",value:function(){var e=this.graphicsObject,t=e.getBorderColor();t=this.graphicsObject.needStroke()?ye(t||4278190080,"#"):0;var n=e.getFillColor();0==e.getFillMode()&&(n=0);var r=e.getBorderWidth();return{color:t,borderTransparent:!0,opacity:e.getOpacity(),fillColor:n,borderWidth:r}}},{key:"initUI",value:function(){var e=this;l(c(n.prototype),"initUI",this).call(this),this.$tip=Ae('<div class="fwr__path-object-tip"></div>'),this.$tip.appendTo(this.$handler);var t=this.rectHammer=new Hammer.Manager(this.$handler[0],{recognizers:[[Hammer.Press]]});return this.$handler.on("mousemove",function(t){e.$tip.hide()}),t.on("press",function(t){if(!Ae(".fv__ui-mobile").length){var n=e.graphicsObject.getRect(),r=Re(e.$handler.parent()[0],t),i={left:r.x+"px",top:r.y+20+"px"};r=e.pageRender.page.reverseDevicePoint([r.x,r.y],e.pageRender.getScale(),e.pageRender.getRotation()),e.$tip.show().css(i).html("object : x:".concat(n.left.toFixed(2),",y:").concat(n.bottom.toFixed(2))+"<br/>mouse: x:".concat(r[0].toFixed(2),",y:").concat(r[1].toFixed(2)))}}),this.$handler}},{key:"showPropertiesDialog",value:function(e){var t=this.dependences.pdfViewer.activePropertiesDialog;this.dependences.pdfViewer.activePropertiesDialog?(t.show(e),t.setViewerComponent(this),this.activePropertiesDialog=t):this.propertiesControl=new a.PropertiesControl(this)}},{key:"getContextMenuComponentName",value:function(){return"fv--path-graphics-object-contextmenu"}},{key:"getContextMenuConfig",value:function(){var e=this;return{selector:"div.fv__shape-control",items:{properties:{name:"properties",nameI18nKey:"viewer_:contextmenu.annot.properties",callback:function(t,n,r){e.showPropertiesDialog(r)}},remove:{name:"delete",nameI18nKey:"viewer_:contextmenu.annot.delete",callback:function(){e.remove()}}}}}},{key:"unActive",value:function(e){var t=this.activePropertiesDialog;t&&t.viewerComponent===this&&t.hide(),l(c(n.prototype),"unActive",this).call(this,e)}},{key:"remove",value:function(){return l(c(n.prototype),"remove",this).call(this),this.dependences.pdfViewer.unActiveElement(this),this.destroy(),this.graphicsObject.remove()}},{key:"destroy",value:function(){this.contextmenu&&this.contextmenu.destroy(),this.propertiesControl&&this.propertiesControl.close(),this.propertiesControl=null,this.rectHammer&&this.rectHammer.destroy(),l(c(n.prototype),"destroy",this).call(this)}}]),n}(y),Re=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=me(r),o=Te(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}},Se=a.Deps.jQuery,we=a.Events,be=function(e){function n(){return t(this,n),h(this,n,arguments)}return f(n,e),r(n,[{key:"_resize",value:function(e,t,r){this.enableUniform="north"!=e&&"south"!=e&&"east"!=e&&"west"!=e,l(c(n.prototype),"_resize",this).call(this,e,t,r)}}]),n}(a.ShapeControl),xe=function(n){function i(e,n,r){return t(this,i),h(this,i,[e,n,r])}return f(i,n),r(i,[{key:"initUI",value:function(){var e=this,t=this,n=this.$handler=Se('<div class="fwr__graphics-object-handler" \n        ></div>');return this.pageRender.pageHandler.$handler.append(n),n.get(0).__graphics_object_component=this,this.shapeControl=new be({prestart:function(){return e.onPrestart()},start:function(t,n,r){return e.onStartUpdateShape(t,n,r)},moving:function(t,n,r){var i=r.offsetX,o=r.offsetY;return e.onShapeMoving(t,n,i,o)},update:function(t,n){return e.onShapeUpdating(t,n)},beforeRotateStart:function(){return e.onBeforeRotateStart()},rotateEnd:function(t,n,r,i){return e.onRotate(t)},afterRotateEnd:function(){return e.onAfterRotateEnd()},rotateStart:function(){return e.onRotateStart()},end:function(t,n,r,i){return e.onShapeUpdateEnd(t,n,r,i)},afterEnd:function(t){return e.onAfterShapeCtrlEnd(t)},resizable:!0,rotatable:!0,enableDiagonally:!0,enableFrame:!0,enableUniform:!0,previewer:!0,enableSizeBox:!0}),this.dependences.pdfViewer.eventEmitter.on(we.zoomToSuccess,this.afterZoom=function(){t.updateShapeControl()}),this.$handler}},{key:"onBeforeRotateStart",value:function(){var t=this;this.dependences.pdfViewer.getAllActiveElements().forEach(function(n){n!==t&&e(n,i)&&t.shapeControl.companion(n.shapeControl)})}},{key:"onAfterRotateEnd",value:function(){this.shapeControl.rotateDegree=0,this.shapeControl.companions.forEach(function(e){return e.rotateDegree=0}),this.shapeControl.clearCompanions()}},{key:"onRotate",value:function(e){var t=this;return this.pageRender.$handler.get(0).classList.remove("fv__cursor-rotation"),this.graphicsObject.setRotation(e).then(function(e){t.updateShapeControl()})}},{key:"updateShapeControl",value:function(){l(c(i.prototype),"updateShapeControl",this).call(this),this.shapeControl.ui.style.transform=""}},{key:"onRotateStart",value:function(){this.pageRender.$handler.get(0).classList.add("fv__cursor-rotation")}},{key:"getContextMenuConfig",value:function(){var e=this;return{selector:"div.fv__shape-control",items:{properties:{name:"properties",nameI18nKey:"viewer_:contextmenu.annot.properties",callback:function(t,n,r){e.showPropertiesDialog(r)}},remove:{name:"delete",nameI18nKey:"viewer_:contextmenu.annot.delete",callback:function(){var t=e.dependences.pdfViewer;if(t.getAllActiveElements().forEach(function(e){e.remove&&e.remove()}),0===t.getAllActiveElements().length){var n=t.getCurrentActivatable();n&&t.unActiveElement(n)}}}}}}},{key:"getContextMenuComponentName",value:function(){return"fv--image-graphics-object-contextmenu"}},{key:"getPropertyOptions",value:function(){return{opacity:this.graphicsObject.getOpacity(),borderStyle:!1}}},{key:"showPropertiesDialog",value:function(e){var t=this.dependences.pdfViewer.activePropertiesDialog;this.dependences.pdfViewer.activePropertiesDialog?(t.show(e),t.setViewerComponent(this),this.activePropertiesDialog=t):this.$propertiesControl=new a.PropertiesControl(this)}},{key:"hidePropertiesDialog",value:function(){this.$propertiesControl&&this.$propertiesControl.close()}},{key:"destroy",value:function(){this.contextmenu&&this.contextmenu.destroy(),this.dependences.pdfViewer.eventEmitter.off(we.zoomToSuccess,this.afterZoom),l(c(i.prototype),"destroy",this).call(this)}},{key:"setOpacity",value:function(e){this.graphicsObject.setOpacity(e)}},{key:"remove",value:function(){l(c(i.prototype),"remove",this).call(this),this.graphicsObject.remove(),this.dependences.pdfViewer.unActiveElement(this),this.destroy()}},{key:"unActive",value:function(e){var t=this.activePropertiesDialog;t&&t.viewerComponent===this&&t.hide(),l(c(i.prototype),"unActive",this).call(this,e)}}]),i}(y),He=function(){function e(){t(this,e),this.matchRules=[]}return r(e,[{key:"registerMatchRule",value:function(e){return this.matchRules.push(e),e}},{key:"unRegisterMatchRule",value:function(e){var t=this.matchRules.indexOf(e);-1!==t&&this.matchRules.splice(t,1)}},{key:"get",value:function(e){for(var t=this.matchRules,n=this.getDefault(e),r=t.length;r--;){var i=t[r];if("function"==typeof i){var o=i(e,n);if(o)return o}}return n}},{key:"getDefault",value:function(e){switch(e.getType()){case 1:return _e;case 2:return Ce;case 3:return xe;default:return y}}}]),e}(),De=a.Deps.Hammer;function Le(e,n){var i=e.graphicsManager,o=["","text","path","image","shading","all"][n],c=o?["fv__edit-",o,"-state-handler"].join(""):"";return c+=" fv__edit-graphics-state-handler",function(a){function s(e){return t(this,s),h(this,s,[e])}return f(s,a),r(s,[{key:"pageHandler",value:function(t){var r=this;this.pageRender=t;var o=t.getPDFPage(),a=t.$handler,s=a[0];a.addClass(c),(this.hammer=new De(s)).on("tap",function(a){if(-1!=a.target.className.indexOf("fv__shape-control-move-area"))return Promise.resolve();r.resetHandler();var c=Pe(s,a);o.then(function(e){return[e,e.reverseDevicePoint([c.x,c.y],t.getScale(),t.getRotation())]}).then(function(e){var t=w(e,2),r=t[0],i=w(t[1],2),o=i[0],a=i[1];return 5===n?r.getGraphicsObjectAtPoint([o,a],5,0):r.getGraphicsObjectAtPoint([o,a],3,n)}).then(function(e){return!e||e.type<1||e.type>3?Promise.reject():[i.get(e),e]}).then(function(n){var r=w(n,2);return new(0,r[0])(r[1],t,e)}).then(function(e){return r.currentComponent=e,e.active()}).catch(function(e){e&&console.error(e),r.currentComponent=null,r.pdfViewer.activeElement()})})}},{key:"destroyPageHandler",value:function(){this.unregisterKeyEvent&&this.unregisterKeyEvent(),this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(c),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponent&&(this.currentComponent.textCharSure&&this.currentComponent.textCharSure(),this.currentComponent.unActive())}}],[{key:"getStateName",value:function(){return"edit-"+o}}]),s}(a.IStateHandler)}var Pe=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=me(r),o=Te(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}},Oe=a.Deps.Hammer;function Ne(e){return function(e){if(Array.isArray(e))return R(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||S(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var ke=function(){function e(){t(this,e)}return r(e,null,[{key:"pointsToRect",value:function(e,t,n){var r=e.x>t.x?t.x:e.x,i=e.x<t.x?t.x:e.x,o=e.y>t.y?t.y:e.y,a=e.y<t.y?t.y:e.y;if(n){var c=o;(o=a)-(a=c)<1&&(o=a+1,a-=1)}else a-o<1&&(a=o+1,o-=1);return i-r<1&&(i=r+1,r-=1),{left:r-2,top:a+1,right:i+2,bottom:o-1}}},{key:"generatePoints",value:function(t,n,r){var i=t.x,o=t.y,a=n.x-i,c=n.y-o;switch(r){case"line":return e.genLinePoints(i,o,a,c);case"square":return e.genSquarePoints(i,o,a,c);case"circle":return e.genOvalPoints(i,o,a,c);case"roundRect":return e.genRoundRectPoints(i,o,a,c)}}},{key:"genLinePoints",value:function(e,t,n,r){var i=[];return i.push(["m",e,t]),i.push(["l",e+n,t+r]),i}},{key:"genOvalPoints",value:function(e,t,n,r){var i=[];return i.push(["m",e+n/2,t]),(i=(i=(i=(i=i.concat(Ie(e+n/2,t,n/2,r/2,1))).concat(Ie(e+n,t+r/2,-n/2,r/2,0))).concat(Ie(e+n/2,t+r,-n/2,-r/2,1))).concat(Ie(e,t+r/2,n/2,-r/2,0))).push(["h",i[0][1],i[0][2]]),i}},{key:"genRoundRectPoints",value:function(e,t,n,r){var i=[],o=.2*n,a=.2*r,c=.8*n,s=.8*r;return i.push(["m",e+o,t]),i.push(["l",e+c,t]),(i=i.concat(Ie(e+c,t,o,a,1))).push(["l",e+n,t+s]),(i=i.concat(Ie(e+n,t+s,-o,a,0))).push(["l",e+o,t+r]),(i=i.concat(Ie(e+o,t+r,-o,-a,1))).push(["l",e,t+a]),(i=i.concat(Ie(e,t+a,o,-a,0))).push(["l",i[0][1],i[0][2]]),i.push(["h"]),i}},{key:"genSquarePoints",value:function(e,t,n,r){var i=[];return i.push(["m",e,t]),i.push(["l",e+n,t]),i.push(["l",e+n,t+r]),i.push(["l",e,t+r]),i.push(["h",e,t]),i}}]),e}();function Ie(e,t,n,r,i){var o=[],a=.5522847498308;return i?(o.push(["c",e+a*n,t]),o.push(["c",e+n,t+a*r]),o.push(["c",e+n,t+r])):(o.push(["c",e,t+a*r]),o.push(["c",e+a*n,t+r]),o.push(["c",e+n,t+r])),o}var je=a.Deps.jQuery,Be=a.Deps.Hammer,Ve=a.IStateHandler,Me=function e(){t(this,e),this.addon=null,this.pathType=0,this.canAdd=!1},Fe=function(e){function n(e){var r;return t(this,n),(r=h(this,n,[e])).destroyHooks=[],r}return f(n,e),r(n,[{key:"addDestroyHook",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r;(r=this.destroyHooks).push.apply(r,Ne(t))}},{key:"addEventTo",value:function(e,t,n){return e.on(t,n),function(){e.off(t,n)}}},{key:"pageHandler",value:function(e){var t=this;this.pageRender=e;var n,r,i=e.pdfViewer.getIoC().getInstanceByClass(Me),o=e.$handler;o.addClass("fv__create-callout-state-handler "+this.cursorStyle),this.shapeDom=(0==(r=(n=o).find(".fv__add-path-preview")).length&&(r=je('<canvas class="fv__add-path-preview" style="position: absolute;display:none"></canvas>'),n.append(r)),r);var a,c,s=o[0],u=this.hammer=new Be.Manager(s,{recognizers:[[Be.Pan,{direction:Be.DIRECTION_ALL}]]}),h=function(e){i.canAdd=-1!=e.target.className.indexOf("fv__pdf-page-handler-container")};this.addDestroyHook(this.addEventTo(o,"mousedown",h),this.addEventTo(o,"touchstart",h),function(){u.destroy()}),u.on("panstart",function(e){i.canAdd&&(a=Ge(s,e))}).on("panend",function(n){if(a){c={x:a.x+n.deltaX,y:a.y+n.deltaY};var r=t.pageRender.page.reverseDevicePoint([a.x,a.y],t.pageRender.getScale(),t.pageRender.getRotation()),o=t.pageRender.page.reverseDevicePoint([c.x,c.y],t.pageRender.getScale(),t.pageRender.getRotation()),s={x:r[0],y:r[1]},u={x:o[0],y:o[1]},h=ke.generatePoints(s,u,i.pathType),l=ke.pointsToRect(s,u);t.pageRender.page.addGraphicsObject({type:2,points:h,rect:l}).then(function(e){return a=null,t.shapeDom.hide(),e}).then(function(e){return e?[i.addon.graphicsManager.get(e),e]:Promise.reject(new Error("Graphics object was not created!"))}).then(function(t){var n=w(t,2);return new(0,n[0])(n[1],e,i.addon)}).then(function(e){t.currentComponet=e,t.pdfViewer.activeElement(e)}).catch(function(e){throw t.currentComponet=null,t.pdfViewer.activeElement(),e})}}).on("panmove",function(e){if(a){c={x:a.x+e.deltaX,y:a.y+e.deltaY};var n=ke.pointsToRect(a,c,!0);!function(e,t,n){var r=n[0],i=r.getContext("2d");i.clearRect(0,0,n.width(),n.height()),r.width=t.right-t.left+4,r.height=t.bottom-t.top+4,i.clearRect(0,0,n.width(),n.height()),i.beginPath(),i.lineWidth=2,i.strokeStyle="#5aa",i.transform(1,0,0,1,2-t.left,2-t.top);for(var o=[],a=0;a<e.length;a++)switch(e[a][0]){case"m":i.moveTo(e[a][1],e[a][2]);break;case"l":i.lineTo(e[a][1],e[a][2]);break;case"c":o.push(e[a][1],e[a][2]),6===o.length&&(i.bezierCurveTo(o[0],o[1],o[2],o[3],o[4],o[5]),o=[]);break;case"h":4===o.length?(i.bezierCurveTo(o[0],o[1],o[2],o[3],e[a][1],e[a][2]),o=[]):i.lineTo(e[a][1],e[a][2]),i.closePath()}i.stroke(),n.css({left:t.left,top:t.top}).show()}(ke.generatePoints(a,c,i.pathType),n,t.shapeDom)}})}},{key:"destroyPageHandler",value:function(){this.destroyHooks.forEach(function(e){return e()}),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponet&&this.currentComponet.destroy()}}],[{key:"setAddon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e?e.pdfViewer:null;t&&(t.getIoC().getInstanceByClass(Me).addon=e)}},{key:"getStateName",value:function(){return"add-path-object"}},{key:"setPathType",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e.getIoC().getInstanceByClass(Me).pathType=t}}]),n}(Ve),Ge=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=me(r),o=Te(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}};function Ue(e,t,n,r,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,i)}function $e(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function a(e){Ue(o,r,i,a,c,"next",e)}function c(e){Ue(o,r,i,a,c,"throw",e)}a(void 0)})}}function Xe(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=c(0),a.throw=c(1),a.return=c(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;var Ye=a.Deps.jQuery,Ke=a.IStateHandler,We=a.Events,ze=a.shared.QueuedAsyncTaskExecutor,qe=function e(){t(this,e),this.addon=null},Qe=function(e){function n(e){return t(this,n),h(this,n,[e])}return f(n,e),r(n,[{key:"pageHandler",value:function(e){var t=this,n=this;this.pageRender=e;var r,i,o=this.pdfViewer.getIoC().getInstanceByClass(qe),a=this.$handler=e.$handler,c=a[0],s=this.hammer=new Hammer.Manager(c,{recognizers:[[Hammer.Tap],[Hammer.Pan,{direction:Hammer.DIRECTION_ALL}]]}),u=new ze;function h(){return $e(function(){var t,n,o,c,s,u,h,l;return Xe(this,function(d){switch(d.label){case 0:return i?[2,i]:[4,et(r)];case 1:return t=d.sent(),n=t.width,o=t.height,c=e.getRotation(),s=3*n/e.page.getPxWidth(),u=3*o/e.page.getPxHeight(),(s>1||u>1)&&((h=Math.max(s,u))>1&&(h=1/h),n*=h,o*=h),90!==c&&270!==c||(l=n,n=o,o=l),i=Ye('<img style="position: absolute;top:200%;left:0;border:2px solid transparent; width:'.concat(n,"px; height:").concat(o,'px" src="').concat(r,'"/>')),a.append(i),[2,i]}})})()}this.pdfViewer.eventEmitter.on(We.addEditImage,this.loadFile=function(e){r=e}),a.off("mouseenter").on("mouseenter",function(e){r&&u.exec(function(){return $e(function(){return Xe(this,function(e){switch(e.label){case 0:return[4,h()];case 1:return e.sent().show(),[2]}})})()})}),a.off("mousemove mousewheel").on("mousemove mousewheel",function(e){if(r){var t=c.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;u.exec(function(){return $e(function(){return Xe(this,function(e){switch(e.label){case 0:return[4,h()];case 1:return e.sent().css({top:i,left:n}),[2]}})})()})}}),a.off("mouseleave").on("mouseleave",function(e){r&&u.exec(function(){return $e(function(){return Xe(this,function(e){switch(e.label){case 0:return[4,h()];case 1:return e.sent().hide(),[2]}})})()})});var l=!0;s.on("tap",function(i){return $e(function(){var t,a,s,u,d,f;return Xe(this,function(p){switch(p.label){case 0:return t=this,l?(l=!1,r?(a={},s=Je(c,i),[4,h()]):[2]):[2];case 1:return u=p.sent(),d=u.width(),f=u.height(),e.getPDFPage().then(function(i){var c,h=e.getRotation(),p=3*d/i.getPxWidth(),v=3*f/i.getPxHeight();if(p>1||v>1){var E=Math.max(p,v);E>1&&(E=1/E),d*=E,f*=E}if(90===h||270===h){var g=d;d=f,f=g}a.top=s.y,a.left=s.x,a.right=a.left+d,a.bottom=a.top+f,(c=r,new Promise(function(e,t){var n=new XMLHttpRequest;n.open("GET",c),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(n.status>=200&&n.status<300||304===n.status?e(n.response):t())},n.onerror=function(){t()},n.send()})).then(function(r){var c=i.reverseDeviceRect(a,e.getScale(),h);i.addImage(r,c,h).then(function(n){if(!n)return t.pdfViewer.getStateHandlerManager().switchTo("edit-all"),u.remove(),t.currentComponet=null,void t.pdfViewer.activeElement();var r=new(o.addon.graphicsManager.get(n))(n,e,o.addon);t.pdfViewer.getStateHandlerManager().switchTo("edit-all"),t.currentComponet=r,u.remove(),l=!0,t.pdfViewer.activeElement(r)}).catch(function(e){e&&console.error(e),n.currentComponet=null,n.pdfViewer.activeElement()})})}),[2]}})}).call(t)})}},{key:"destroyPageHandler",value:function(){this.$handler.off("mousemove mousewheel mouseleave"),this.$handler.empty(),this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(this.cursorStyle),this.pdfViewer.eventEmitter.off(We.addEditImage,this.loadFile)}},{key:"out",value:function(){this.destroyPageHandler()}}],[{key:"setAddon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e?e.pdfViewer:null;t&&(t.getIoC().getInstanceByClass(qe).addon=e)}},{key:"getStateName",value:function(){return"add-image-object"}}]),n}(Ke),Je=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=me(r),o=Te(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}};var Ze=new Map;function et(e){return Ze.has(e)?Promise.resolve(Ze.get(e)):new Promise(function(t,n){var r=new Image;r.setAttribute("crossOrigin","Anonymous"),r.onload=function(){var n=r.width,i=r.height;Ze.set(e,{imageURL:e,width:n,height:i}),t({imageURL:e,width:n,height:i})},r.onerror=function(){n("Fail to load image:"+e)},r.src=e})}var tt="fv__add-text-object-state-handler",nt=a.Deps.Hammer;var rt=function(e){return e[e.ALL=0]="ALL",e[e.TEXT=1]="TEXT",e[e.PATH=2]="PATH",e[e.IMAGE=3]="IMAGE",e[e.SHADING=4]="SHADING",e[e.FORM_X_OBJECT=5]="FORM_X_OBJECT",e}({}),it=a.shared.areaSelections,ot=it.Selections,at=it.SelectionEventType,ct=it.createAreaLimitationReducer,st=it.BorderStyle,ut=a.Deps.Hammer,ht=a.shared.activation.ActivationGroup,lt=a.shared.keyboardStatus,dt=a.shared.QueuedAsyncTaskExecutor,ft={};function pt(e){var n=e.graphicsManager,i="fv__edit-all-state-handler fv__edit-graphics-state-handler";return function(o){function c(e){var n;return t(this,c),(n=h(this,c,[e])).destroyHooks=[],n}return f(c,o),r(c,[{key:"pageHandler",value:function(t){var r=this,o=new ht;this.pageRender=t;var c=t.getPDFPage(),s=t.$handler,u=s[0];s.addClass(i);var h=new dt;this.selections=new ot({anchorElement:u,borderStyle:st.DOTTED}),this.selections.reducer(ct(u)),this.selections.reducer(function(e){if(void 0!==e){var t=u.getBoundingClientRect();return Object.assign({left:e.clientLeft-t.left,top:e.clientTop-t.top},e)}}),this.selections.eventInterceptor(function(e){return e.target===u});var l=!1;this.selections.eventInterceptor(function(e){return l});var d=function(e){l=e.target===u};u.addEventListener("mousedown",d),u.addEventListener("touchstart",d),this.destroyHooks.push(function(){u.removeEventListener("mousedown",d),u.removeEventListener("touchstart",d)}),this.selections.on(at.END,function(i){h.exec(function(){return c.then(function(c){var s=r.pageRender.scale,u=r.pageRender.getRotation(),h=c.reverseDeviceRect({left:i.left,right:i.left+i.width,top:i.top,bottom:i.top+i.height},s,u),l=Math.min(2/r.pageRender.scale,2);return c.getGraphicsObjectsInRect(h,l,rt.ALL).then(function(i){!i||i.length<1||(p()||o.clear(),r.pdfViewer.activeElement(o),i.forEach(function(r){var i=r.getRect();if(!(i.right-i.left<1||i.top-i.bottom<1)){var a=new(n.get(r))(r,t,e);o.add(a)}}),r.pdfViewer.eventEmitter.emit(a.Events.activeElementChanged))})})})});var f=this.hammer=new ut(u);f.on("tap",function(i){r.resetHandler();var s,h,l,d,f,v=(s=i,h=u.getBoundingClientRect(),l=s.srcEvent,d=me(l),f=Te(l),{x:d-h.left-s.deltaX,y:f-h.top-s.deltaY});c.then(function(e){return[e,e.reverseDevicePoint([v.x,v.y],t.getScale(),t.getRotation())]}).then(function(e){var t=w(e,2),n=t[0],r=w(t[1],2),i=r[0],o=r[1];return n.getGraphicsObjectAtPoint([i,o],5,0)}).then(function(e){return e?e.type<1||e.type>3?Promise.reject():[n.get(e),e]:Promise.reject(ft)}).then(function(n){var r=w(n,2);return new(0,r[0])(r[1],t,e)}).then(function(e){if(r.currentComponent=e,p()){var t=i.target.closest(".fwr__graphics-object-handler");if(t){var n=o.activations.find(function(e){return!!e.$handler&&e.$handler.get(0)===t});if(n)return o.remove(n),void r.pdfViewer.activeElement(o)}}else o.clear();o.add(e),r.pdfViewer.activeElement(o),r.pdfViewer.eventEmitter.emit(a.Events.tapGraphicsObject,e.getGraphicsObject())}).catch(function(e){e===ft&&p()||(e!==ft&&e&&console.error(e),r.currentComponent=null,r.pdfViewer.activeElement())})}),this.destroyHooks.push(function(){return f.destroy()},function(){return r.selections.destroy()},function(){o.clear(),r.pdfViewer.unActiveElement(o)});var p=function(){return!!r.pdfViewer.isShortcutKeyEnabled()&&(a.DeviceInfo.isMac?lt.isWin:lt.isCtrl)}}},{key:"destroyPageHandler",value:function(){this.hammer&&this.hammer.destroy(),this.destroyHooks.forEach(function(e){return e()}),this.pageRender.$handler.removeClass(i),this.resetHandler(),this.pageRender=null,this.destroyHooks=null}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponent&&this.currentComponent.textCharSure&&this.currentComponent.textCharSure()}}],[{key:"getStateName",value:function(){return"edit-all"}}]),c}(a.IStateHandler)}var vt=function(){function e(n){t(this,e),this.pdfViewer=n,this.graphicsManager=new He,this.pdfViewer.addon=this}return r(e,[{key:"init",value:function(){var e,n,i,o=this,c=function(e){var n=e.graphicsManager,i="text",o=i?["fv__edit-",i,"-state-handler"].join(""):"";return o+=" fv__edit-graphics-state-handler",function(a){function c(e){return t(this,c),h(this,c,[e])}return f(c,a),r(c,[{key:"pageHandler",value:function(t){var r=this;this.pageRender=t;var i=t.$handler,a=i[0];i.addClass(o);var c=this.hammer=new Oe.Manager(a,{recognizers:[[Oe.Pan,{direction:Oe.DIRECTION_ALL}]]});c.add(new Oe.Tap({event:"doubletap",taps:2})),c.add(new Oe.Tap({event:"singletap"})),c.get("doubletap").recognizeWith("singletap"),c.get("singletap").requireFailure("doubletap"),c.on("singletap",function(i){r.resetHandler();var o=i.changedPointers[0];t.getPDFPage().then(function(e){return[e,e.reverseDevicePoint([o.offsetX,o.offsetY],t.getScale(),t.getRotation())]}).then(function(e){var t=w(e,2),n=t[0],r=w(t[1],2),i=r[0],o=r[1];return n.getGraphicsObjectAtPoint([i,o],3,1)}).then(function(e){return e?[n.get(e),e]:Promise.reject(new Error("Text object not found at this position: [".concat(o.offsetX,", ").concat(o.offsetY,"]")))}).then(function(n){var r=w(n,2);return new(0,r[0])(r[1],t,e)}).then(function(e){return r.currentComponet=e,e.active()}).catch(function(e){e&&console.error(e),r.currentComponet=null,r.pdfViewer.activeElement()})}),c.on("doubletap",function(i){r.resetHandler();var o=i.changedPointers[0];t.getPDFPage().then(function(e){return[e,e.reverseDevicePoint([o.offsetX,o.offsetY],t.getScale(),t.getRotation())]}).then(function(e){var t=w(e,2),n=t[0],r=w(t[1],2),i=r[0],o=r[1];return n.getGraphicsObjectAtPoint([i,o],3,1)}).then(function(e){return e?[n.get(e),e]:Promise.reject(new Error("Text object not found at this position: [".concat(o.offsetX,", ").concat(o.offsetY,"]")))}).then(function(n){var r=w(n,2);return new(0,r[0])(r[1],t,e)}).then(function(e){return r.currentComponet=e,e.activeCharEdit()}).catch(function(e){e&&console.error(e),r.currentComponet=null,r.pdfViewer.activeElement()})})}},{key:"destroyPageHandler",value:function(){this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(o),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponet&&(this.currentComponet.textCharSure&&this.currentComponet.textCharSure(),this.currentComponet.unActive())}}],[{key:"getStateName",value:function(){return"edit-"+i}}]),c}(a.IStateHandler)}(this),s=Le(this,2),u=Le(this,3),l=pt(this),d=(n=(e=this).graphicsManager,i=function(){function e(){t(this,e),this.currentEditingGraphicComponent=null}return r(e,[{key:"allInjected",value:function(){var e=this;this.pdfViewer.eventEmitter.on(a.ViewerEvents.willCloseDocument,function(){e.currentEditingGraphicComponent&&e.currentEditingGraphicComponent.isActive&&e.currentEditingGraphicComponent.unActive(),e.currentEditingGraphicComponent=null})}},{key:"applyCurrent",value:function(){var e=this.currentEditingGraphicComponent;e&&(e.textCharSure&&e.textCharSure(),e.unActive(),this.currentEditingGraphicComponent=null)}}],[{key:"inject",value:function(){return{pdfViewer:a.PDFViewer}}}]),e}(),function(o){function c(e){var n;return t(this,c),(n=h(this,c,[e])).service=e.getIoC().getInstanceByClass(i),n}return f(c,o),r(c,[{key:"pageHandler",value:function(t){var r=this;this.pageRender=t;var i=t.getPDFPage(),o=t.$handler,c=o[0];o.addClass(tt),(this.hammer=new nt(c)).on("tap",function(o){r.resetHandler();var c=o.changedPointers[0];i.then(function(e){return[e,e.reverseDevicePoint([c.offsetX,c.offsetY],t.getScale(),t.getRotation())]}).then(function(e){var n=w(e,2),i=n[0],o=w(n[1],2),c=o[0],s=o[1],u=i.getRotationAngle(),h=new a.Matrix;h.rotate((u+t.getRotation())/180*Math.PI),h.translate(c,s);var l=r.pdfViewer.store.getCurrentValue("add-text-object-param-transfer");return i.addGraphicsObject(Object.assign({},l,{originPosition:{x:c,y:s}},{type:1,matrix:h.toArray()}))}).then(function(e){return e?[n.get(e),e]:Promise.reject(new Error("Graphics object was not created!"))}).then(function(n){var r=w(n,2);return new(0,r[0])(r[1],t,e)}).then(function(e){return r.service.currentEditingGraphicComponent=e,r.currentGraphicComponent=e,e.activeCharEdit()}).catch(function(e){e&&console.error(e),r.service.currentEditingGraphicComponent=null,r.currentGraphicComponent=null,r.pdfViewer.activeElement()})})}},{key:"destroyPageHandler",value:function(){this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(tt),this.pdfViewer.getEventEmitter().off(b.addTextObjectParamTransfer,this.addTextObjectParamTransferBind),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.service.currentEditingGraphicComponent&&this.service.applyCurrent()}}],[{key:"getStateName",value:function(){return"add-text-object"}}]),c}(a.IStateHandler)),p=this.pdfViewer.getStateHandlerManager();[c,s,u,l,Fe,d,Qe].forEach(function(e){e.setAddon&&e.setAddon(o),p.register(e)}),this.pdfViewer.addDestroyHook(function(){Fe.setAddon(null,o.pdfViewer),Qe.setAddon(null,o.pdfViewer)})}},{key:"getGraphicsManager",value:function(){return this.graphicsManager}},{key:"receiveAction",value:function(e,t){"activeFillSignText"===e&&(createPredefinedTextStateHandler.setParams(t[0],this.pdfViewer),this.pdfViewer.getStateHandlerManager().switchTo("add-fill-predefined-text","predefined-text"))}}]),e}()})(),o})());